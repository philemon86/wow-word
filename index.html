<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>éˆæ„Ÿå¯«æ‰‹ Mobile (æ•´åˆåŠ å¼·ç‰ˆ)</title>

  <!-- OpenCC (é–‹æº CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

  <style>
    :root {
      --primary: #007aff;
      --bg: #f2f2f7;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --border: #c6c6c8;
      --warn: #ff9500;
      --danger: #ff3b30;
      --toolbar-height: 60px;
      --kb-offset: 0px; /* éµç›¤å½ˆèµ·æ™‚å‘ä¸Šä½ç§» */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0; background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }

    /* 1. é ‚éƒ¨å°èˆª */
    header {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      padding: 10px 16px; border-bottom: 0.5px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; z-index: 100;
    }
    .brand { font-size: 17px; font-weight: 800; }
    .status-badge {
      font-size: 11px; padding: 4px 8px; border-radius: 12px;
      background: #e5e5ea; color: #8e8e93; transition: 0.2s;
      font-weight: 700;
    }
    .status-badge.saving { background: var(--primary); color: white; }
    .status-badge.danger { background: var(--danger); color: white; }
    .status-badge.ok { background: #34c759; color: white; }

    /* 2. Tabs */
    .tabs-nav {
      display: flex; padding: 8px 16px 0; background: var(--bg); border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      flex: 1; padding: 10px; text-align: center; font-size: 15px; font-weight: 800;
      color: #8e8e93; border-bottom: 3px solid transparent; transition: 0.2s; cursor: pointer;
      user-select: none;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* 3. å…§å®¹å®¹å™¨ */
    .viewport { flex: 1; position: relative; overflow: hidden; background: var(--card-bg); }
    .page {
      position: absolute; inset: 0; display: none; flex-direction: column;
      padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    .page.active { display: flex; }

    textarea {
      flex: 1; width: 100%; border: none; outline: none; resize: none;
      font-size: 18px; line-height: 1.65; padding-bottom: 90px;
      font-family: inherit; background: transparent;
    }

    /* é è¦½å€é«˜äº® */
    .highlight-scripture { background: #d1e7dd; color: #0f5132; padding: 0 2px; border-radius: 4px; font-weight: 800; }
    .highlight-typo { text-decoration: line-through; color: #8e8e93; margin-right: 2px; }
    .highlight-correction { background: #fff3cd; color: #b45309; font-weight: 900; padding: 0 4px; border-radius: 4px; }

    /* 4. ç¶“æ–‡æµ®çª— */
    .verse-pop {
      position: fixed;
      bottom: calc(var(--toolbar-height) + 20px + env(safe-area-inset-bottom) + var(--kb-offset));
      left: 16px; right: 16px;
      background: #1c1c1e; color: white; padding: 16px; border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: none; z-index: 200; transform: translateY(20px); opacity: 0;
      transition: all 0.22s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .verse-pop.show { display: block; transform: translateY(0); opacity: 1; }
    .pop-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; gap: 10px; }
    .pop-ref { color: #60a5fa; font-weight: 900; font-size: 16px; }
    .pop-body { max-height: 120px; overflow-y: auto; font-size: 15px; opacity: 0.95; margin-bottom: 14px; line-height: 1.55; white-space: pre-wrap; }
    .pop-actions { display: flex; gap: 10px; }

    /* 5. åº•éƒ¨å·¥å…·åˆ— (å¯æ»‘å‹•) */
    .bottom-toolbar {
      height: var(--toolbar-height);
      padding: 8px 16px calc(8px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.98); border-top: 0.5px solid var(--border);
      display: flex; gap: 12px; overflow-x: auto; align-items: center;
      scrollbar-width: none;
    }
    .bottom-toolbar::-webkit-scrollbar { display: none; }

    .tool-btn {
      padding: 8px 14px; border-radius: 10px; border: 1px solid #e5e5ea;
      background: #f2f2f7; font-size: 13px; font-weight: 800; white-space: nowrap; flex-shrink: 0;
      color: #333; user-select: none;
    }
    .tool-btn:active { background: #e5e5ea; transform: scale(0.96); }
    .btn-main { background: var(--primary); color: white; border: none; }
    .btn-danger { color: var(--danger); background: #fff5f5; border-color: #fee2e2; }

    .toggle-group { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666; white-space: nowrap; user-select: none; }
    .toggle-group input { transform: translateY(1px); }
    .sep { width: 1px; height: 20px; background: #ddd; flex-shrink: 0; }
  </style>
</head>

<body>

  <header>
    <div class="brand">âœï¸ éˆæ„Ÿå¯«æ‰‹</div>
    <div id="autosaveBadge" class="status-badge">è¼‰å…¥ä¸­...</div>
  </header>

  <div class="tabs-nav">
    <div class="tab-btn active" onclick="switchTab('edit')">ç·¨è¼¯å¯«ä½œ</div>
    <div class="tab-btn" onclick="switchTab('preview')">æ ¡ç¨¿é è¦½</div>
  </div>

  <div class="viewport">
    <div id="page-edit" class="page active">
      <textarea id="inputText" placeholder="åœ¨é€™è£¡å¯«ä½œ... è¼¸å…¥ã€Œå¤ª1.1ã€ã€Œä¼¯7.3-8.1ã€æœƒè‡ªå‹•åµæ¸¬ç¶“æ–‡ï¼ˆæ”¯æ´å°¾å·´æ¨™é»ï¼‰"></textarea>

      <div id="versePop" class="verse-pop">
        <div class="pop-header">
          <span id="versePopRef" class="pop-ref"></span>
          <span style="font-size:12px; color:#aaa;">åµæ¸¬åˆ°ç¶“æ–‡</span>
        </div>
        <div id="versePopText" class="pop-body"></div>
        <div class="pop-actions">
          <button class="tool-btn btn-main" style="flex:2" onclick="insertVerse()">æ’å…¥</button>
          <button class="tool-btn" style="flex:1" onclick="closeVersePop()">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div id="page-preview" class="page">
      <div id="output" style="line-height: 1.85; font-size: 18px;"></div>
    </div>
  </div>

  <div class="bottom-toolbar">
    <button class="tool-btn btn-main" onclick="applyFixesToInput()">ğŸª„ ä¸€éµä¿®æ­£</button>
    <button class="tool-btn" onclick="toTraditional()">ç¹é«”</button>
    <button class="tool-btn" onclick="toSimplified()">ç°¡é«”</button>
    <button class="tool-btn" onclick="copyInput()">ğŸ“ è¤‡è£½è¼¸å…¥</button>
    <button class="tool-btn" onclick="copyResult()">ğŸ“‹ è¤‡è£½é è¦½</button>

    <div class="sep"></div>
    <label class="toggle-group"><input type="checkbox" id="autoVerseToggle" checked> ç¶“æ–‡</label>
    <label class="toggle-group"><input type="checkbox" id="replaceRefToggle" checked> å–ä»£</label>
    <label class="toggle-group"><input type="checkbox" id="allowChapterToggle"> æ•´ç« </label>
    <div class="sep"></div>

    <button class="tool-btn btn-danger" onclick="clearText()">æ¸…ç©º</button>
  </div>

<script>
/* =========================================================
   0) å°å·¥å…·ï¼šå‰ªè²¼ç°¿ï¼ˆiOS/ç€è¦½å™¨æ¬Šé™ fallbackï¼‰
   ========================================================= */
async function safeClipboardWrite(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch (e) {}
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.top = '-9999px';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return !!ok;
  } catch (e) {
    return false;
  }
}

/* =========================================================
   1) UI æ§åˆ¶ï¼šTabsï¼ˆä½ åŸæœ¬çš„ï¼Œä¿ç•™ï¼‰
   ========================================================= */
let currentTab = 'edit';
function switchTab(tabName) {
  currentTab = tabName;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

  if(tabName === 'edit') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('page-edit').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('page-preview').classList.add('active');
    processText(); // é è¦½æ™‚æ‰é‹ç®—
  }
}

/* =========================================================
   2) éµç›¤ä¸Šç§»ï¼šè®“ verse toast ä¸è¢« iOS éµç›¤è“‹ä½
   ========================================================= */
function bindKeyboardOffset() {
  if (!window.visualViewport) return;
  const vv = window.visualViewport;
  const update = () => {
    // ä¼°ç®—éµç›¤é«˜åº¦ï¼ˆè¦–è¦ºè¦–å£ç¸®å°é€ æˆçš„å·®ï¼‰
    const kb = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
    document.documentElement.style.setProperty('--kb-offset', kb + 'px');
  };
  vv.addEventListener('resize', update);
  vv.addEventListener('scroll', update);
  update();
}

/* =========================================================
   3) éŒ¯åˆ¥å­—èˆ‡è¦å‰‡åº«ï¼ˆä¿ç•™ + å¯æ“´å……ï¼‰
   ========================================================= */
const hardRules = [
  ['ä¸Šå¸', 'ç¥'],
  ['å°', 'è‡º'],
];

const typoCorrections = {
  'å®‰ç¥¥':'å®‰è©³','å°ç£':'è‡ºç£','è¬›å°':'è¬›è‡º','å§Šå¦¹':'å§å¦¹','è£é¢':'è£¡é¢',
  'ç”šéº¼':'ä»€éº¼','ç§˜å¯†':'ç¥•å¯†','å¥§ç§˜':'å¥§ç¥•','æŒ‰æ­¥å°±ç­':'æŒ‰éƒ¨å°±ç­','ä¸æ˜ç©¶ç†':'ä¸æ˜å°±è£¡',
  'æ·¬ç·´':'æ·¬éŠ','å€Ÿæ©Ÿ':'è—‰æ©Ÿ','æ‹¼å‘½':'æ‹šå‘½','ç…é‚£':'å‰é‚£','èº«ä»½':'èº«åˆ†',
  'ç†Ÿæ»':'ç†Ÿç¨”','ç„¡æ‰€é©äº‹':'ç„¡æ‰€äº‹äº‹','æ’’é¦¬åˆ©äº':'æ’’ç‘ªåˆ©äº','åšè¦‹è­‰':'ä½œè¦‹è­‰','æŠµæ¯€':'è©†æ¯€',
  'æœä¾':'æœäº‹','æ¨¡æ“¬å…©å¯':'æ¨¡ç¨œå…©å¯','ç´„æ—¦æ²³':'ç´„ä½†æ²³','ä¼¸ä»—':'ä¼¸æ–','æ’’æ—¦':'æ’’ä½†',
  'ç”Ÿæ´»ç„¡æ…®':'ç”Ÿæ´»ç„¡è™','å‘¨å…­':'é€±å…­','çœ¼è‡‰':'çœ¼ç¼','éƒ¨ä»½':'éƒ¨åˆ†','æ·ºç§»é»˜åŒ–':'æ½›ç§»é»˜åŒ–',
  'ä½ˆæ»¿':'å¸ƒæ»¿','ç¹å»¶':'ç¹è¡','å…¬ä½ˆ':'å…¬å¸ƒ','é »è‡¨':'ç€•è‡¨','ä½ˆç½®':'å¸ƒç½®',
  'æœ­æ ¹':'æ‰æ ¹','æ‰ç‡Ÿ':'ç´®ç‡Ÿ','æ‰å¯¦':'ç´®å¯¦','ç§˜è¨£':'ç¥•è¨£','é›¨éå¤©æ™´':'é›¨éå¤©é’',
  'æ™´å¤©éœ¹é‚':'é’å¤©éœ¹é‚','è¬›åœ‹èª':'è¬›ä¸­æ–‡','è‡ºèª':'é–©å—èª','èƒŒé€†':'æ‚–é€†','å¿…éœ€':'å¿…é ˆ',
  'é ˆè¦':'éœ€è¦','æ¼«å»¶':'è”“å»¶','ç¶‘ç¶':'æ†ç¶','é£¢è’':'é¥‘è’','è­¦é†’':'å„†é†’',
  'å¤¢é¨':'å¤¢é­˜','è£œé¢¨':'æ•é¢¨','ä¸æŠ€ä¸æ±‚':'ä¸å¿®ä¸æ±‚','æ—¥æ¼¸å¥½è½‰':'æ—¥è¦‹å¥½è½‰','æ¦»é™·':'å¡Œé™·',
  'è¦ç•«':'è¦åŠƒ','ä¼ç•«':'ä¼åŠƒ'
};

/* =========================================================
   4) ç¶“æ–‡ç°¡ç¨±ï¼ˆä½ åŸæœ¬æ ¡ç¨¿é«˜äº®ç”¨ï¼Œä¿ç•™ï¼‰
   ========================================================= */
const bookAbbreviations = {
  'å‰µä¸–è¨˜':'å‰µ','å‡ºåŸƒåŠè¨˜':'å‡º','åˆ©æœªè¨˜':'åˆ©','æ°‘æ•¸è¨˜':'æ°‘','ç”³å‘½è¨˜':'ç”³',
  'ç´„æ›¸äºè¨˜':'æ›¸','å£«å¸«è¨˜':'å£«','è·¯å¾—è¨˜':'å¾—','æ’’æ¯è€³è¨˜ä¸Š':'æ’’ä¸Š','æ’’æ¯è€³è¨˜ä¸‹':'æ’’ä¸‹',
  'åˆ—ç‹ç´€ä¸Š':'ç‹ä¸Š','åˆ—ç‹ç´€ä¸‹':'ç‹ä¸‹','æ­·ä»£å¿—ä¸Š':'ä»£ä¸Š','æ­·ä»£å¿—ä¸‹':'ä»£ä¸‹','ä»¥æ–¯æ‹‰è¨˜':'æ‹‰',
  'å°¼å¸Œç±³è¨˜':'å°¼','ä»¥æ–¯å¸–è¨˜':'æ–¯','ç´„ä¼¯è¨˜':'ä¼¯','è©©ç¯‡':'è©©','ç®´è¨€':'ç®´',
  'å‚³é“æ›¸':'å‚³','é›…æ­Œ':'æ­Œ','ä»¥è³½äºæ›¸':'è³½','è€¶åˆ©ç±³æ›¸':'è€¶','è€¶åˆ©ç±³å“€æ­Œ':'å“€',
  'ä»¥è¥¿çµæ›¸':'çµ','ä½†ä»¥ç†æ›¸':'ä½†','ä½•è¥¿é˜¿æ›¸':'ä½•','ç´„ç¥æ›¸':'ç¥','é˜¿æ‘©å¸æ›¸':'æ‘©',
  'ä¿„å·´åº•äºæ›¸':'ä¿„','ç´„æ‹¿æ›¸':'æ‹¿','å½Œè¿¦æ›¸':'å½Œ','é‚£é´»æ›¸':'é´»','å“ˆå·´è°·æ›¸':'å“ˆ',
  'è¥¿ç•ªé›…æ›¸':'ç•ª','å“ˆè©²æ›¸':'è©²','æ’’è¿¦åˆ©äºæ›¸':'äº','ç‘ªæ‹‰åŸºæ›¸':'ç‘ª',
  'é¦¬å¤ªç¦éŸ³':'å¤ª','é¦¬å¯ç¦éŸ³':'å¯','è·¯åŠ ç¦éŸ³':'è·¯','ç´„ç¿°ç¦éŸ³':'ç´„','ä½¿å¾’è¡Œå‚³':'å¾’',
  'ç¾…é¦¬æ›¸':'ç¾…','å“¥æ—å¤šå‰æ›¸':'æ—å‰','å“¥æ—å¤šå¾Œæ›¸':'æ—å¾Œ','åŠ æ‹‰å¤ªæ›¸':'åŠ ','ä»¥å¼—æ‰€æ›¸':'å¼—',
  'è…“ç«‹æ¯”æ›¸':'è…“','æ­Œç¾…è¥¿æ›¸':'è¥¿','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'å¸–å‰','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'å¸–å¾Œ','ææ‘©å¤ªå‰æ›¸':'æå‰',
  'ææ‘©å¤ªå¾Œæ›¸':'æå¾Œ','æå¤šæ›¸':'å¤š','è…“åˆ©é–€æ›¸':'é–€','å¸Œä¼¯ä¾†æ›¸':'ä¾†','é›…å„æ›¸':'é›…',
  'å½¼å¾—å‰æ›¸':'å½¼å‰','å½¼å¾—å¾Œæ›¸':'å½¼å¾Œ','ç´„ç¿°ä¸€æ›¸':'ç´„ä¸€','ç´„ç¿°äºŒæ›¸':'ç´„äºŒ','ç´„ç¿°ä¸‰æ›¸':'ç´„ä¸‰',
  'çŒ¶å¤§æ›¸':'çŒ¶','å•Ÿç¤ºéŒ„':'å•Ÿ',
  'é¦¬å¤ª':'å¤ª','é¦¬å¯':'å¯','è·¯åŠ ':'è·¯','ç´„ç¿°':'ç´„'
};

/* =========================================================
   5) Book Mapï¼ˆç”¨æ–¼ bible.csv æª¢ç´¢ï¼‰
   ========================================================= */
const bookMap = {
  'å‰µ':'Gen','å‰µä¸–':'Gen','å‰µä¸–è¨˜':'Gen',
  'å‡º':'Exo','å‡ºåŸƒåŠ':'Exo','å‡ºåŸƒåŠè¨˜':'Exo',
  'åˆ©':'Lev','åˆ©æœª':'Lev','åˆ©æœªè¨˜':'Lev',
  'æ°‘':'Num','æ°‘æ•¸':'Num','æ°‘æ•¸è¨˜':'Num',
  'ç”³':'Deu','ç”³å‘½':'Deu','ç”³å‘½è¨˜':'Deu',
  'æ›¸':'Jos','ç´„æ›¸äº':'Jos','ç´„æ›¸äºè¨˜':'Jos',
  'å£«':'Jug','å£«å¸«':'Jug','å£«å¸«è¨˜':'Jug',
  'å¾—':'Rut','è·¯å¾—':'Rut','è·¯å¾—è¨˜':'Rut',
  'æ’’ä¸Š':'1Sa','æ’’æ¯è€³ä¸Š':'1Sa','æ’’æ¯è€³è¨˜ä¸Š':'1Sa',
  'æ’’ä¸‹':'2Sa','æ’’æ¯è€³ä¸‹':'2Sa','æ’’æ¯è€³è¨˜ä¸‹':'2Sa',
  'ç‹ä¸Š':'1Ki','åˆ—ç‹ä¸Š':'1Ki','åˆ—ç‹è¨˜ä¸Š':'1Ki',
  'ç‹ä¸‹':'2Ki','åˆ—ç‹ä¸‹':'2Ki','åˆ—ç‹è¨˜ä¸‹':'2Ki',
  'ä»£ä¸Š':'1Ch','æ­·ä»£ä¸Š':'1Ch','æ­·ä»£å¿—ä¸Š':'1Ch',
  'ä»£ä¸‹':'2Ch','æ­·ä»£ä¸‹':'2Ch','æ­·ä»£å¿—ä¸‹':'2Ch',
  'æ‹‰':'Ezr','ä»¥æ–¯æ‹‰':'Ezr','ä»¥æ–¯æ‹‰è¨˜':'Ezr',
  'å°¼':'Neh','å°¼å¸Œç±³':'Neh','å°¼å¸Œç±³è¨˜':'Neh',
  'æ–¯':'Est','ä»¥æ–¯å¸–':'Est','ä»¥æ–¯å¸–è¨˜':'Est',
  'ä¼¯':'Job','ç´„ä¼¯':'Job','ç´„ä¼¯è¨˜':'Job',
  'è©©':'Psm','è©©ç¯‡':'Psm',
  'ç®´':'Pro','ç®´è¨€':'Pro',
  'å‚³':'Ecc','å‚³é“':'Ecc','å‚³é“æ›¸':'Ecc',
  'æ­Œ':'Son','é›…æ­Œ':'Son',
  'è³½':'Isa','ä»¥è³½äº':'Isa','ä»¥è³½äºæ›¸':'Isa',
  'è€¶':'Jer','è€¶åˆ©ç±³':'Jer','è€¶åˆ©ç±³æ›¸':'Jer',
  'å“€':'Lam','è€¶åˆ©ç±³å“€':'Lam','è€¶åˆ©ç±³å“€æ­Œ':'Lam',
  'çµ':'Eze','ä»¥è¥¿çµ':'Eze','ä»¥è¥¿çµæ›¸':'Eze',
  'ä½†':'Dan','ä½†ä»¥ç†':'Dan','ä½†ä»¥ç†æ›¸':'Dan',
  'ä½•':'Hos','ä½•è¥¿é˜¿':'Hos','ä½•è¥¿é˜¿æ›¸':'Hos',
  'ç¥':'Joe','ç´„ç¥':'Joe','ç´„ç¥æ›¸':'Joe',
  'æ‘©':'Amo','é˜¿æ‘©å¸':'Amo','é˜¿æ‘©å¸æ›¸':'Amo',
  'ä¿„':'Oba','ä¿„å·´åº•äº':'Oba','ä¿„å·´åº•äºæ›¸':'Oba',
  'æ‹¿':'Jon','ç´„æ‹¿':'Jon','ç´„æ‹¿æ›¸':'Jon',
  'å½Œ':'Mic','å½Œè¿¦':'Mic','å½Œè¿¦æ›¸':'Mic',
  'é´»':'Nah','é‚£é´»':'Nah','é‚£é´»æ›¸':'Nah',
  'å“ˆ':'Hab','å“ˆå·´è°·':'Hab','å“ˆå·´è°·æ›¸':'Hab',
  'ç•ª':'Zep','è¥¿ç•ªé›…':'Zep','è¥¿ç•ªé›…æ›¸':'Zep',
  'è©²':'Hag','å“ˆè©²':'Hag','å“ˆè©²æ›¸':'Hag',
  'äº':'Zec','æ’’è¿¦åˆ©äº':'Zec','æ’’è¿¦åˆ©äºæ›¸':'Zec',
  'ç‘ª':'Mal','ç‘ªæ‹‰åŸº':'Mal','ç‘ªæ‹‰åŸºæ›¸':'Mal',
  'å¤ª':'Mat','é¦¬å¤ª':'Mat','é¦¬å¤ªç¦éŸ³':'Mat',
  'å¯':'Mak','é¦¬å¯':'Mak','é¦¬å¯ç¦éŸ³':'Mak',
  'è·¯':'Luk','è·¯åŠ ':'Luk','è·¯åŠ ç¦éŸ³':'Luk',
  'ç´„':'Jhn','ç´„ç¿°':'Jhn','ç´„ç¿°ç¦éŸ³':'Jhn',
  'å¾’':'Act','ä½¿å¾’':'Act','ä½¿å¾’è¡Œå‚³':'Act',
  'ç¾…':'Rom','ç¾…é¦¬':'Rom','ç¾…é¦¬æ›¸':'Rom',
  'æ—å‰':'1Co','å“¥æ—å¤šå‰':'1Co','å“¥æ—å¤šå‰æ›¸':'1Co',
  'æ—å¾Œ':'2Co','å“¥æ—å¤šå¾Œ':'2Co','å“¥æ—å¤šå¾Œæ›¸':'2Co',
  'åŠ ':'Gal','åŠ æ‹‰å¤ª':'Gal','åŠ æ‹‰å¤ªæ›¸':'Gal',
  'å¼—':'Eph','ä»¥å¼—æ‰€':'Eph','ä»¥å¼—æ‰€æ›¸':'Eph',
  'è…“':'Phl','è…“ç«‹æ¯”':'Phl','è…“ç«‹æ¯”æ›¸':'Phl',
  'è¥¿':'Col','æ­Œç¾…è¥¿':'Col','æ­Œç¾…è¥¿æ›¸':'Col',
  'å¸–å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'1Ts',
  'å¸–å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'2Ts',
  'æå‰':'1Ti','ææ‘©å¤ªå‰':'1Ti','ææ‘©å¤ªå‰æ›¸':'1Ti',
  'æå¾Œ':'2Ti','ææ‘©å¤ªå¾Œ':'2Ti','ææ‘©å¤ªå¾Œæ›¸':'2Ti',
  'å¤š':'Tit','æå¤š':'Tit','æå¤šæ›¸':'Tit',
  'é–€':'Phm','è…“åˆ©é–€':'Phm','è…“åˆ©é–€æ›¸':'Phm',
  'ä¾†':'Heb','å¸Œä¼¯ä¾†':'Heb','å¸Œä¼¯ä¾†æ›¸':'Heb',
  'é›…':'Jas','é›…å„':'Jas','é›…å„æ›¸':'Jas',
  'å½¼å‰':'1Pe','å½¼å¾—å‰':'1Pe','å½¼å¾—å‰æ›¸':'1Pe',
  'å½¼å¾Œ':'2Pe','å½¼å¾—å¾Œ':'2Pe','å½¼å¾—å¾Œæ›¸':'2Pe',
  'ç´„ä¸€':'1Jn','ç´„ç¿°ä¸€':'1Jn','ç´„ç¿°ä¸€æ›¸':'1Jn',
  'ç´„äºŒ':'2Jn','ç´„ç¿°äºŒ':'2Jn','ç´„ç¿°äºŒæ›¸':'2Jn',
  'ç´„ä¸‰':'3Jn','ç´„ç¿°ä¸‰':'3Jn','ç´„ç¿°ä¸‰æ›¸':'3Jn',
  'çŒ¶':'Jud','çŒ¶å¤§':'Jud','çŒ¶å¤§æ›¸':'Jud',
  'å•Ÿ':'Rev','å•Ÿç¤º':'Rev','å•Ÿç¤ºéŒ„':'Rev'
};
const sortedBookNames = Object.keys(bookMap).sort((a,b)=>b.length-a.length);

/* =========================================================
   6) ç« æ•¸è½‰ä¸­æ–‡ï¼ˆä¿ç•™ï¼‰
   ========================================================= */
function chineseToNumber(chineseNum){
  const cnNums={'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9};
  const cnUnits={'å':10,'ç™¾':100,'åƒ':1000,'è¬':10000};
  if (/^\d+$/.test(chineseNum)) return parseInt(chineseNum,10);
  let total=0, section=0, number=0, unitOps=false;
  for(let i=0;i<chineseNum.length;i++){
    const c=chineseNum.charAt(i);
    if(cnNums.hasOwnProperty(c)){ number=cnNums[c]; unitOps=false; }
    else if(cnUnits.hasOwnProperty(c)){
      let unit=cnUnits[c];
      if(unit===10 && number===0 && !unitOps) number=1;
      section=(section+number)*unit;
      total+=section; section=0;
      number=0; unitOps=true;
    } else if(/\d/.test(c)){ number=parseInt(c,10); }
  }
  if(!unitOps) total+=number;
  if(total===0 && chineseNum.startsWith('å')){
    let temp=10;
    if(chineseNum.length>1) temp+=cnNums[chineseNum[1]]||0;
    return temp;
  }
  return total>0?total:number;
}
function numberToChinese(num){
  const cnNums=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  const cnUnits=['','å','ç™¾','åƒ'];
  num = parseInt(num,10);
  if(num===0) return 'é›¶';
  if(num===10) return 'å';
  if(num>10 && num<20) return 'å'+cnNums[num%10];
  let str='', s=num.toString(), len=s.length;
  for(let i=0;i<len;i++){
    let n=parseInt(s.charAt(len-i-1));
    let digit=cnNums[n], unit=cnUnits[i];
    if(n!==0) str=digit+unit+str;
    else if(str.length>0 && !str.startsWith('é›¶')) str='é›¶'+str;
  }
  return str.replace(/é›¶+$/,'');
}

/* =========================================================
   7) Bible CSV è¼‰å…¥ + Workerï¼ˆä¿ç•™ï¼‰
   ========================================================= */
let bibleData=[];
let bibleReady=false;

let openccReady=false;
let t2s=null, s2t=null;

async function initOpenCC(){
  try{
    t2s = OpenCC.Converter({ from:'tw', to:'cn' });
    s2t = OpenCC.Converter({ from:'cn', to:'tw' });
    openccReady=true;
  }catch(e){
    openccReady=false;
    console.warn('OpenCC init fail', e);
  }
}

function parseCSVInWorker(csvText){
  return new Promise((resolve)=>{
    const workerCode = `
      self.onmessage = (e) => {
        const lines = e.data.split(/\\r?\\n/);
        const out = [];
        for (let i=1;i<lines.length;i++){
          const row = lines[i]; if(!row) continue;
          const parts = row.split(',');
          if(parts.length>=4){
            const c = parseInt(parts[1].trim());
            const v = parseInt(parts[2].trim());
            if(!isNaN(c) && !isNaN(v)){
              out.push({
                book: parts[0].trim(),
                chapter: c,
                verse: v,
                text: parts.slice(3).join(',').trim(),
                id: c*1000 + v
              });
            }
          }
        }
        postMessage(out);
      };
    `;
    const blob=new Blob([workerCode],{type:'application/javascript'});
    const worker=new Worker(URL.createObjectURL(blob));
    worker.onmessage=(ev)=>{ bibleData=ev.data||[]; worker.terminate(); resolve(); };
    worker.postMessage(csvText);
  });
}

async function loadBibleCSV(){
  try{
    setAutosaveBadge('è¼‰å…¥ bible.csvâ€¦', 'saving');
    const res = await fetch(`./bible.csv?v=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=(await res.text()).replace(/^\uFEFF/,'');
    await parseCSVInWorker(text);
    bibleReady=true;
    setAutosaveBadge('CSV OK', 'ok');
    setTimeout(()=>setAutosaveBadge('æº–å‚™å°±ç·’', 'idle'), 900);
  }catch(e){
    bibleReady=false;
    setAutosaveBadge('CSV å¤±æ•—', 'danger');
  }
}

/* =========================================================
   8) ç¶“æ–‡å¼•ç”¨è§£æï¼ˆä¿ç•™ + å¼·åŒ–ï¼šæ¨™é»å‰é™¤ï¼‰
   ========================================================= */
function cnToNum(str){
  const val = chineseToNumber(str);
  return isNaN(val) ? null : val;
}

function parseRefPart(str, defaultBook, defaultChapter){
  let bookKey=defaultBook;
  let remain=str;
  let hasBookInStr=false;

  for(const key of sortedBookNames){
    if(str.startsWith(key)){
      bookKey=bookMap[key];
      remain=str.substring(key.length);
      hasBookInStr=true;
      break;
    }
  }

  remain=remain.replace(/[.ï¼ã€‚,ï¼Œ]/g,':');
  let c,v, splitIdx=-1;

  const isDigit=(ch)=>/[0-9]/.test(ch);
  const isCnDigit=(ch)=>/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]/.test(ch);

  for(let i=0;i<remain.length-1;i++){
    if(isCnDigit(remain[i]) && isDigit(remain[i+1])){ splitIdx=i+1; break; }
  }

  if(remain.includes(':')){
    const p=remain.split(':');
    c = cnToNum(p[0]) || parseInt(p[0]);
    v = cnToNum(p[1]) || parseInt(p[1]);
  }else if(splitIdx!==-1){
    c = cnToNum(remain.substring(0,splitIdx));
    v = parseInt(remain.substring(splitIdx));
  }else{
    const val = cnToNum(remain) || parseInt(remain);
    if(defaultChapter && !hasBookInStr){ c=defaultChapter; v=val; }
    else { c=val; v=null; }
  }

  return { book: bookKey, chapter: c, verse: v, id: (c && v) ? (c*1000+v) : null, isChapterOnly: (c && !v) };
}

function parseSearchQuery(input){
  let clean=input.replace(/\s+/g,'')
                 .replace(/[.ï¼ã€‚,ï¼Œ]/g,':')
                 .replace(/[â€”~ï½]/g,'-');

  // ä¸­æ–‡æ•¸å­— + é˜¿æ‹‰ä¼¯æ•¸å­—äº¤ç•Œï¼ˆå¤ªä¸€1ï¼‰
  clean=clean.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾])(\d)/g,'$1:$2');

  if(clean.includes('-')){
    const [startStr,endStr]=clean.split('-');
    const startObj=parseRefPart(startStr,null,null);
    if(!startObj.chapter) return null;

    const contextChap = startObj.verse ? startObj.chapter : null;
    const endObj=parseRefPart(endStr,startObj.book,contextChap);
    if(!endObj.book) endObj.book=startObj.book;

    let startId=startObj.id;
    let endId=0;

    if(endObj.verse) endId=endObj.chapter*1000+endObj.verse;
    else endId=endObj.chapter*1000+999;

    if(startObj.isChapterOnly) startId=startObj.chapter*1000;

    return { type:'range', book:startObj.book, startId, endId };
  }else{
    const obj=parseRefPart(clean,null,null);
    return { type:'single', book:obj.book, chapter:obj.chapter, verse:obj.verse };
  }
}

/* =========================================================
   9) æŸ¥æ‰¾èˆ‡æ’å…¥
   ========================================================= */
function bookCodeToShort(bookCode){
  const keys = Object.keys(bookMap).filter(k=>bookMap[k]===bookCode);
  if(!keys.length) return bookCode;
  keys.sort((a,b)=>a.length-b.length);
  return keys[0];
}
function formatRefShort(bookCode, chapter, verse){
  const short=bookCodeToShort(bookCode);
  const chapChi=numberToChinese(parseInt(chapter));
  const vStr = (verse!==null && verse!==undefined) ? String(verse) : '';
  return `ï¼ˆ${short}${chapChi}${vStr}ï¼‰`;
}
function findVersesByQuery(query){
  if(!bibleReady || !query) return [];
  if(query.type==='range'){
    return bibleData.filter(e=>e.book===query.book && e.id>=query.startId && e.id<=query.endId);
  }
  if(!query.book || !query.chapter) return [];
  const c=parseInt(query.chapter);
  if(query.verse===null || query.verse===undefined){
    return bibleData.filter(e=>e.book===query.book && e.chapter===c);
  }
  const v=parseInt(query.verse);
  return bibleData.filter(e=>e.book===query.book && e.chapter===c && e.verse===v);
}
function buildInsertText(verses){
  if(!verses.length) return '';
  return verses.map(e=>`${e.text} ${formatRefShort(e.book, e.chapter, e.verse)}`).join('\n');
}

/* =========================================================
   10) åµæ¸¬é‚è¼¯ï¼ˆå¼·åŒ–ç‰ˆï¼šæ”¯æ´å°¾å·´æ¨™é» / æ‹¬è™Ÿï¼‰
   ========================================================= */
let lastDetected = null;

function getLastTokenNearCursor(text, cursor){
  // ä»¥ã€Œç©ºç™½/æ›è¡Œã€ç‚ºç•Œï¼Œå–æ¸¸æ¨™é™„è¿‘ token
  let i = cursor - 1;
  while(i>=0 && !/\s/.test(text[i])) i--;
  const start=i+1;

  let j = cursor;
  while(j<text.length && !/\s/.test(text[j])) j++;
  const end=j;

  return { token:text.slice(start,end), start, end };
}

// å»æ‰ token å‰å¾Œå¸¸è¦‹æ¨™é»ï¼ˆä½†ä¿ç•™ : - . é€™äº›æœƒç”¨åœ¨ç¶“æ–‡ï¼‰
function cleanToken(raw){
  if(!raw) return '';
  let s = raw.trim();

  // å…ˆå‰æ‰æ‹¬è™Ÿèˆ‡æ›¸åè™Ÿç­‰åŒ…è£¹
  s = s.replace(/^[\(\ï¼ˆ\[\{ã€Œã€ã€ã€Š<]+/g, '');
  s = s.replace(/[\)\ï¼‰\]\}ã€ã€ã€‘ã€‹>]+$/g, '');

  // å†å‰æ‰å°¾å·´å¥è®€ï¼ˆå¸¸è¦‹ï¼šã€‚ ï¼Œ ã€ ï¼ ï¼Ÿ ï¼› ï¼šï¼‰
  s = s.replace(/[ï¼Œã€‚ã€ï¼›;!ï¼?ï¼Ÿ]+$/g, '');

  // è‹¥é‚„æœ‰å¼•è™Ÿçµå°¾
  s = s.replace(/[â€â€™"'ã€ã€]+$/g, '');

  return s.trim();
}

function maybeDetectVerse(){
  const autoOn = document.getElementById('autoVerseToggle').checked;
  if(!autoOn) return;

  const ta = document.getElementById('inputText');
  const text = ta.value;
  const cursor = ta.selectionStart;

  const { token, start, end } = getLastTokenNearCursor(text, cursor);
  const cleaned = cleanToken(token);

  if(!cleaned || cleaned.length < 2){
    closeVersePop();
    return;
  }

  const q = parseSearchQuery(cleaned);
  if(!q){
    closeVersePop();
    return;
  }

  // å…è¨±æ•´ç« æµ®çª—ï¼Ÿï¼ˆé è¨­é—œï¼Œé¿å…ä½ æ‰“ã€Œå‰µ1ã€å°±å™´ï¼‰
  const allowChapter = document.getElementById('allowChapterToggle').checked;
  if(q.type==='single' && (q.verse===null || q.verse===undefined) && !allowChapter){
    closeVersePop();
    return;
  }

  // é è¦½æœ€å¤š 30 ç¯€ï¼ˆæ•´ç« ä¹Ÿåˆ‡ 30ï¼Œé¿å… toast çˆ†ï¼‰
  const verses = findVersesByQuery(q).slice(0, 30);
  if(!verses.length){
    closeVersePop();
    return;
  }

  const insertText = buildInsertText(verses);
  lastDetected = { token, cleaned, start, end, verses, insertText };

  const pop = document.getElementById('versePop');
  const refEl = document.getElementById('versePopRef');
  const txtEl = document.getElementById('versePopText');

  const first = verses[0];
  refEl.textContent = formatRefShort(first.book, first.chapter, first.verse);
  txtEl.textContent = insertText;
  pop.classList.add('show');
}

function closeVersePop(){
  document.getElementById('versePop').classList.remove('show');
  lastDetected = null;
}

function insertVerse(){
  if(!lastDetected) return;

  const ta = document.getElementById('inputText');
  const replaceOn = document.getElementById('replaceRefToggle').checked;

  const insertText = lastDetected.insertText;

  // å–ä»£æ™‚ï¼šç”¨ token çš„ start/endï¼›ä¸å–ä»£ï¼šç”¨ç•¶ä¸‹é¸å–
  const before = ta.value.slice(0, replaceOn ? lastDetected.start : ta.selectionStart);
  const after  = ta.value.slice(replaceOn ? lastDetected.end : ta.selectionEnd);

  ta.value = before + insertText + after;

  const pos = (before + insertText).length;
  ta.focus();
  ta.setSelectionRange(pos, pos);

  closeVersePop();
  triggerAutosave();
  if(currentTab === 'preview') processText();
}

/* =========================================================
   11) æ ¡ç¨¿ï¼šé è¦½ + ä¸€éµå¥—ç”¨ï¼ˆä¿ç•™ä½ çš„é‚è¼¯ + å®‰å…¨ escapeï¼‰
   ========================================================= */
function applyHardRulesPlain(text){
  for(const [from,to] of hardRules){
    text = text.split(from).join(to);
  }
  return text;
}
function applyTyposPlain(text){
  const keys = Object.keys(typoCorrections).sort((a,b)=>b.length-a.length);
  for(const k of keys){
    text = text.split(k).join(typoCorrections[k]);
  }
  return text;
}
function getCleanFixedText(text){
  text = applyHardRulesPlain(text);
  text = applyTyposPlain(text);
  return text;
}
function escapeHtml(s){
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}
function processText(){
  const inputEl=document.getElementById('inputText');
  const outputEl=document.getElementById('output');
  let text=inputEl.value;

  if(!text){
    outputEl.innerHTML='<span style="color:#999;">ç­‰å¾…è¼¸å…¥...</span>';
    return;
  }

  let preview = escapeHtml(text);

  // ç¡¬è¦å‰‡æ¨™ç¤º
  for(const [from,to] of hardRules){
    const re=new RegExp(from.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview = preview.replace(re, `<span class="highlight-typo">${from}</span><span class="highlight-correction">${to}</span>`);
  }

  // éŒ¯åˆ¥å­—æ¨™ç¤º
  for(let typo in typoCorrections){
    const correction=typoCorrections[typo];
    const re=new RegExp(typo.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview=preview.replace(re, `<span class="highlight-typo">${typo}</span><span class="highlight-correction">${correction}</span>`);
  }

  // ç¶“æ–‡å¼•ç”¨é«˜äº®ï¼ˆä½ åŸæœ¬ï¼šæ‹¬è™Ÿå…§ï¼‰
  preview = preview.replace(/ï¼ˆ([^ï¼‰]+)ï¼‰/g, function(match, content){
    let foundBook=null, bookAbbr='';
    let sortedBooks=Object.keys(bookAbbreviations).sort((a,b)=>b.length-a.length);
    for(let book of sortedBooks){
      if(content.startsWith(book)){
        foundBook=book;
        bookAbbr=bookAbbreviations[book];
        break;
      }
    }
    if(!foundBook) return match;

    let remain=content.substring(foundBook.length).trim();
    let cleanRef=remain.replace(/[ç« ç¯‡ç¯€\s]/g,':').replace(/[:ï¼š.ï¼]+/g,':');
    let parts=cleanRef.split(':').filter(p=>p);
    if(parts.length===0) return match;

    let chapter=parts[0];
    let verse=parts.length>1 ? parts[1] : '';
    let chapterNum=chineseToNumber(chapter);
    let chapterChi=numberToChinese(chapterNum);

    let verseStr='';
    if(verse){
      if(verse.includes('-')||verse.includes('ï¼')||verse.includes('è‡³')){
        let vParts=verse.split(/[-ï¼è‡³]/);
        let v1=chineseToNumber(vParts[0]);
        let v2=chineseToNumber(vParts[1]);
        verseStr=`${v1}-${v2}`;
      }else{
        verseStr=chineseToNumber(verse).toString();
      }
    }

    let newRef=`ï¼ˆ${bookAbbr}${chapterChi}${verseStr}ï¼‰`;
    return `<span class="highlight-scripture">${newRef}</span>`;
  });

  preview = preview.replace(/\n/g,'<br>');
  outputEl.innerHTML=preview;
}

function applyFixesToInput(){
  const ta=document.getElementById('inputText');
  ta.value = getCleanFixedText(ta.value);
  triggerAutosave();
  if(currentTab === 'preview') processText();
  alert('å·²å®Œæˆä¸€éµä¿®æ­£');
}

/* =========================================================
   12) OpenCC è½‰æ›ï¼ˆä¿ç•™ï¼‰
   ========================================================= */
function toSimplified(){
  if(!openccReady){
    alert('OpenCC è¼‰å…¥ä¸­...ï¼ˆå¯èƒ½ç¶²è·¯æ…¢ï¼‰');
    return;
  }
  const ta=document.getElementById('inputText');
  let out=t2s(ta.value);
  out=getCleanFixedText(out);
  ta.value=out;
  triggerAutosave();
  if(currentTab === 'preview') processText();
}
function toTraditional(){
  if(!openccReady){
    alert('OpenCC è¼‰å…¥ä¸­...ï¼ˆå¯èƒ½ç¶²è·¯æ…¢ï¼‰');
    return;
  }
  const ta=document.getElementById('inputText');
  let out=s2t(ta.value);
  out=getCleanFixedText(out);
  ta.value=out;
  triggerAutosave();
  if(currentTab === 'preview') processText();
}

/* =========================================================
   13) è¤‡è£½ / æ¸…ç©º
   ========================================================= */
async function copyInput(){
  const ta=document.getElementById('inputText');
  const ok = await safeClipboardWrite(ta.value);
  alert(ok ? 'å¯«ä½œå…§å®¹å·²è¤‡è£½' : 'è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™ï¼‰');
}

async function copyResult(){
  const outputEl=document.getElementById('output');
  let tempDiv=document.createElement('div');
  tempDiv.innerHTML=outputEl.innerHTML;

  // ç§»é™¤éŒ¯å­—åŸæ–‡ï¼Œåªç•™æ›´æ­£å¾Œ
  tempDiv.querySelectorAll('.highlight-typo').forEach(el=>el.remove());
  const finalCopyText = tempDiv.innerText;

  const ok = await safeClipboardWrite(finalCopyText);
  alert(ok ? 'æ ¡ç¨¿çµæœå·²è¤‡è£½' : 'è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™ï¼‰');
}

function clearText(){
  if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')){
    document.getElementById('inputText').value='';
    document.getElementById('output').innerHTML='';
    localStorage.removeItem('writer_draft_v1');
    closeVersePop();
    setAutosaveBadge('å·²æ¸…ç©º', 'danger');
  }
}

/* =========================================================
   14) è‡ªå‹•å­˜æª”ï¼ˆä¿®æ­£ badge ç‹€æ…‹ï¼›æ›´é †ï¼‰
   ========================================================= */
let autosaveTimer=null;
function setAutosaveBadge(text, mode='idle'){
  const b=document.getElementById('autosaveBadge');
  b.textContent = text;

  b.classList.remove('saving','danger','ok');
  if(mode==='saving') b.classList.add('saving');
  if(mode==='danger') b.classList.add('danger');
  if(mode==='ok') b.classList.add('ok');
}

function triggerAutosave(){
  clearTimeout(autosaveTimer);
  setAutosaveBadge('å„²å­˜ä¸­â€¦', 'saving');

  const saveWork = () => {
    try{
      const ta=document.getElementById('inputText');
      localStorage.setItem('writer_draft_v1', ta.value);
      setAutosaveBadge('å·²å„²å­˜', 'ok');
      setTimeout(()=>setAutosaveBadge('æº–å‚™å°±ç·’', 'idle'), 900);
    }catch(e){
      setAutosaveBadge('å„²å­˜å¤±æ•—', 'danger');
    }
  };

  autosaveTimer=setTimeout(()=>{
    if('requestIdleCallback' in window){
      requestIdleCallback(saveWork, { timeout: 800 });
    }else{
      saveWork();
    }
  }, 450);
}

/* =========================================================
   15) åˆå§‹åŒ–ï¼šOpenCC + CSV + è‰ç¨¿ + åµæ¸¬äº‹ä»¶
   ========================================================= */
window.addEventListener('load', async ()=>{
  bindKeyboardOffset();

  await initOpenCC();
  await loadBibleCSV();

  const ta=document.getElementById('inputText');
  const saved=localStorage.getItem('writer_draft_v1');
  if(saved){
    ta.value=saved;
    setAutosaveBadge('è‰ç¨¿å·²æ¢å¾©', 'ok');
    setTimeout(()=>setAutosaveBadge('æº–å‚™å°±ç·’', 'idle'), 900);
  }else{
    setAutosaveBadge('æº–å‚™å°±ç·’', 'idle');
  }

  // è¾“å…¥ï¼šå­˜æª” + ç¶“æ–‡åµæ¸¬ï¼ˆé è¦½ä¸è·‘æ ¡ç¨¿ï¼Œä¿æŒå¿«ï¼‰
  ta.addEventListener('input', ()=>{
    triggerAutosave();
    clearTimeout(window.__verseDetectTimer);
    window.__verseDetectTimer=setTimeout(maybeDetectVerse, 220);
  });

  // æ¸¸æ¨™ç§»å‹•ä¹Ÿèƒ½åµæ¸¬ï¼ˆå›é ­è£œæ¨™é»å¾ˆæœ‰ç”¨ï¼‰
  ta.addEventListener('keyup', (e)=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      clearTimeout(window.__verseDetectTimer);
      window.__verseDetectTimer=setTimeout(maybeDetectVerse, 180);
    }
  });

  // å¿«æ·éµï¼šEsc é—œæµ®çª—ï¼›Alt+Enter æ’å…¥
  document.addEventListener('keydown', (e)=>{
    const popShown = document.getElementById('versePop').classList.contains('show');
    if(e.key==='Escape' && popShown) closeVersePop();
    if(e.altKey && e.key==='Enter' && popShown){
      e.preventDefault();
      insertVerse();
    }
  });
});
</script>
</body>
</html>
