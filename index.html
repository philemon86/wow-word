<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¯«ä½œï¼‹æ ¡ç¨¿ï¼‹ç¶“æ–‡å¿«æ’</title>

  <!-- OpenCC (é–‹æº) - CDN ç›´æ¥è¼‰å…¥ -->
  <!-- opencc-js æä¾› CDN script å¼•ç”¨èˆ‡ locale ä»£ç¢¼ï¼ˆcn/tw/twp/hk...ï¼‰ã€‚ -->
  <!-- é€™è£¡ç”¨ full.jsï¼šæˆ‘å€‘è¦ tw<->cn é›™å‘ã€‚ -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

  <style>
    :root{
      --primary-color:#4a90e2;
      --bg-color:#f4f7f6;
      --card-bg:#ffffff;
      --text-color:#333;
      --border-radius:12px;
      --shadow:0 4px 6px rgba(0,0,0,.1);
      --muted:#7a7a7a;
      --ok:#20a162;
      --warn:#d97706;
    }
    *{box-sizing:border-box;}
    body{
      font-family:"Microsoft JhengHei","PingFang TC",Arial,sans-serif;
      margin:0; padding:20px;
      background:var(--bg-color);
      color:var(--text-color);
      line-height:1.6;
    }
    h1{
      text-align:center;
      color:#2c3e50;
      margin:0 0 10px 0;
      font-size:1.6rem;
    }
    .sub{
      text-align:center;
      color:var(--muted);
      font-size:.95rem;
      margin-bottom:18px;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      height:calc(100vh - 140px);
      min-height:640px;
    }
    .panel{
      background:var(--card-bg);
      border-radius:var(--border-radius);
      box-shadow:var(--shadow);
      padding:18px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      border-bottom:2px solid #eee;
      padding-bottom:10px;
      flex-wrap:wrap;
    }
    .panel-header h2{
      margin:0;
      font-size:1.05rem;
      color:#555;
      white-space:nowrap;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    button{
      padding:8px 12px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      transition:all .15s;
      font-weight:700;
      background:#e9ecef;
      color:#334155;
      user-select:none;
    }
    button:hover{filter:brightness(.98);}
    .btn-primary{background:var(--primary-color); color:#fff;}
    .btn-primary:hover{background:#357abd;}
    .btn-danger{background:#ff6b6b; color:#fff;}
    .btn-ghost{
      background:transparent;
      border:1px solid #ddd;
      color:#475569;
      font-weight:700;
    }
    .btn-ok{background:var(--ok); color:#fff;}
    .btn-warn{background:var(--warn); color:#fff;}
    .badge{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      background:#f1f5f9;
      color:#475569;
      border:1px solid #e2e8f0;
      font-weight:700;
      white-space:nowrap;
    }

    textarea, .output-content{
      width:100%;
      flex-grow:1;
      border:1px solid #ddd;
      border-radius:10px;
      padding:14px;
      font-size:16px;
      box-sizing:border-box;
      resize:none;
      outline:none;
      overflow-y:auto;
      background:#fafafa;
      white-space:pre-wrap;
      font-family:inherit;
    }
    textarea:focus{border-color:var(--primary-color); background:#fff;}
    .output-content{background:#fff; border:1px solid #e0e0e0;}

    /* é«˜äº®æ¨£å¼ï¼ˆé è¦½ç”¨ï¼‰ */
    .highlight-scripture{background:#d1e7dd; color:#0f5132; padding:2px 4px; border-radius:4px; font-weight:800;}
    .highlight-typo{background:#f8d7da; color:#842029; text-decoration:line-through; padding:0 2px; margin-right:4px;}
    .highlight-correction{background:#fff3cd; color:#664d03; font-weight:800; padding:2px 4px; border-radius:4px; border-bottom:2px solid #ffecb5;}

    /* ç¶“æ–‡å¿«æ’æµ®çª— */
    .verse-pop{
      position:absolute;
      left:18px; right:18px;
      bottom:18px;
      background:#0b1220;
      color:#e5e7eb;
      border-radius:14px;
      padding:12px 12px 10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      display:none;
      z-index:50;
    }
    .verse-pop.show{display:block;}
    .verse-pop .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .verse-pop .ref{
      font-weight:900;
      color:#93c5fd;
    }
    .verse-pop .meta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .verse-pop .text{
      font-size:15px;
      line-height:1.55;
      color:#f8fafc;
      opacity:.95;
      max-height:120px;
      overflow:auto;
      padding-right:4px;
    }
    .tiny{
      font-size:12px;
      opacity:.85;
      color:#cbd5e1;
    }
    .switch{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:13px;
      color:#475569;
      user-select:none;
    }
    .switch input{transform:translateY(1px);}

    @media (max-width: 900px){
      body{padding:10px;}
      .container{grid-template-columns:1fr; height:auto; min-height:auto;}
      .panel{min-height:380px;}
      h1{font-size:1.35rem;}
    }
  </style>
</head>

<body>
  <h1>âœï¸ å¯«ä½œ / æ ¡ç¨¿ / ç¶“æ–‡å¿«æ’ï¼ˆå–®ä¸€è¼¸å…¥æ¡†ï¼‰</h1>
  <div class="sub">æ‰“ <b>å¤ª1.1</b>ã€<b>ä¼¯7.3-8.1</b> æœƒè‡ªå‹•è·³å‡ºç¶“æ–‡é è¦½ï¼›å¯ä¸€éµæ’å…¥æˆ–å–ä»£å¼•ç”¨ã€‚è‡ªå‹•å­˜æª”é¿å…ã€Œæ‰“åˆ°ä¸€åŠä¸è¦‹ã€ã€‚</div>

  <div class="container">
    <!-- å·¦ï¼šå¯«ä½œ -->
    <div class="panel" id="leftPanel">
      <div class="panel-header">
        <h2>åŸå§‹æ–‡ç« ï¼ˆå¯«ä½œå€ï¼‰</h2>
        <div class="toolbar">
          <span class="badge" id="autosaveBadge">æœªå­˜æª”</span>
          <label class="switch" title="åµæ¸¬åˆ° å¤ª1.1 é€™ç¨®æ ¼å¼å°±è·³å‡ºç¶“æ–‡é è¦½">
            <input type="checkbox" id="autoVerseToggle" checked />
            è‡ªå‹•è·³ç¶“æ–‡
          </label>
          <label class="switch" title="æŒ‰æ’å…¥æ™‚ï¼Œç”¨ç¶“æ–‡å–ä»£ä½ å‰›å‰›æ‰“çš„ å¤ª1.1ï¼ˆå¦å‰‡æ’åœ¨æ¸¸æ¨™è™•ï¼‰">
            <input type="checkbox" id="replaceRefToggle" checked />
            å–ä»£å¼•ç”¨
          </label>
          <button class="btn-ghost" onclick="cutText()">å‰ªä¸‹</button>
          <button class="btn-ghost" onclick="pasteText()">è²¼ä¸Š</button>
          <button class="btn-ghost" onclick="copyInput()">è¤‡è£½</button>
          <button class="btn-danger" onclick="clearText()">æ¸…ç©º</button>
        </div>
      </div>
      <textarea id="inputText" placeholder="åœ¨é€™è£¡å¯«ã€‚ä¾‹ï¼šæˆ‘æƒ³åˆ°ï¼ˆå¤ª1.1ï¼‰... æˆ–ç›´æ¥æ‰“ å¤ª1.1 ç„¶å¾ŒæŒ‰æ’å…¥ã€‚"></textarea>

      <!-- ç¶“æ–‡å¿«æ’æµ®çª— -->
      <div class="verse-pop" id="versePop">
        <div class="top">
          <div>
            <div class="ref" id="versePopRef">ï¼ˆå¤ªä¸€1ï¼‰</div>
            <div class="tiny" id="versePopHint">Alt + Enter æ’å…¥</div>
          </div>
          <div class="meta">
            <button class="btn-ok" onclick="insertVerse()">æ’å…¥</button>
            <button class="btn-ghost" onclick="closeVersePop()">é—œé–‰</button>
          </div>
        </div>
        <div class="text" id="versePopText">è¼‰å…¥ä¸­â€¦</div>
      </div>
    </div>

    <!-- å³ï¼šæ ¡ç¨¿é è¦½ / å¥—ç”¨ -->
    <div class="panel">
      <div class="panel-header">
        <h2>æ ¡ç¨¿çµæœï¼ˆé è¦½ï¼‰</h2>
        <div class="toolbar">
          <button class="btn-secondary" onclick="processText()">âŸ³ é‡æ–°æ•´ç†</button>
          <button class="btn-ok" onclick="applyFixesToInput()" title="æŠŠä¿®æ­£å¾Œçš„ç´”æ–‡å­—ç›´æ¥è¦†è“‹å›å·¦é‚Šå¯«ä½œå€ï¼ˆä½ èªªä¸æƒ³å°ç…§ï¼‰">âœ… ç›´æ¥å¥—ç”¨ä¿®æ­£</button>
          <button class="btn-warn" onclick="toTraditional()">ç¹é«”åŒ–</button>
          <button class="btn-warn" onclick="toSimplified()">ç°¡é«”åŒ–</button>
          <button class="btn-primary" onclick="copyResult()">ğŸ“‹ è¤‡è£½æ ¡ç¨¿çµæœ</button>
        </div>
      </div>
      <div id="output" class="output-content"></div>
    </div>
  </div>

<script>
/* =========================================================
   A) ä½ çš„éŒ¯åˆ¥å­— / è¦å‰‡ï¼ˆå¯ä¸€ç›´æ“´å……ï¼‰
   - é¡å¤–ç¡¬è¦å‰‡ï¼šå°â†’è‡ºã€ä¸Šå¸â†’ç¥ï¼ˆä½ æŒ‡å®šï¼‰
   ========================================================= */

const hardRules = [
  ['ä¸Šå¸', 'ç¥'],
  // ã€Œå°ã€ä¸€å¾‹æ”¹ã€Œè‡ºã€ï¼šé€™å¾ˆå…‡ï¼Œé€£ã€Œå°ç©é›»ã€ä¹Ÿæœƒè®Šã€Œè‡ºç©é›»ã€ï¼Œä½ å°±æ˜¯è¦é€™ç¨®ä¸€è‡´æ€§å°±ç…§åšã€‚
  ['å°', 'è‡º'],
];

const typoCorrections = {
  'å®‰ç¥¥':'å®‰è©³','å°ç£':'è‡ºç£','è¬›å°':'è¬›è‡º','å§Šå¦¹':'å§å¦¹','è£é¢':'è£¡é¢',
  'ç”šéº¼':'ä»€éº¼','ç§˜å¯†':'ç¥•å¯†','å¥§ç§˜':'å¥§ç¥•','æŒ‰æ­¥å°±ç­':'æŒ‰éƒ¨å°±ç­','ä¸æ˜ç©¶ç†':'ä¸æ˜å°±è£¡',
  'æ·¬ç·´':'æ·¬éŠ','å€Ÿæ©Ÿ':'è—‰æ©Ÿ','æ‹¼å‘½':'æ‹šå‘½','ç…é‚£':'å‰é‚£','èº«ä»½':'èº«åˆ†',
  'ç†Ÿæ»':'ç†Ÿç¨”','ç„¡æ‰€é©äº‹':'ç„¡æ‰€äº‹äº‹','æ’’é¦¬åˆ©äº':'æ’’ç‘ªåˆ©äº','åšè¦‹è­‰':'ä½œè¦‹è­‰','æŠµæ¯€':'è©†æ¯€',
  'æœä¾':'æœäº‹','æ¨¡æ“¬å…©å¯':'æ¨¡ç¨œå…©å¯','ç´„æ—¦æ²³':'ç´„ä½†æ²³','ä¼¸ä»—':'ä¼¸æ–','æ’’æ—¦':'æ’’ä½†',
  'ç”Ÿæ´»ç„¡æ…®':'ç”Ÿæ´»ç„¡è™','å‘¨å…­':'é€±å…­','çœ¼è‡‰':'çœ¼ç¼','éƒ¨ä»½':'éƒ¨åˆ†','æ·ºç§»é»˜åŒ–':'æ½›ç§»é»˜åŒ–',
  'ä½ˆæ»¿':'å¸ƒæ»¿','ç¹å»¶':'ç¹è¡','å…¬ä½ˆ':'å…¬å¸ƒ','é »è‡¨':'ç€•è‡¨','ä½ˆç½®':'å¸ƒç½®',
  'æœ­æ ¹':'æ‰æ ¹','æ‰ç‡Ÿ':'ç´®ç‡Ÿ','æ‰å¯¦':'ç´®å¯¦','ç§˜è¨£':'ç¥•è¨£','é›¨éå¤©æ™´':'é›¨éå¤©é’',
  'æ™´å¤©éœ¹é‚':'é’å¤©éœ¹é‚','è¬›åœ‹èª':'è¬›ä¸­æ–‡','è‡ºèª':'é–©å—èª','èƒŒé€†':'æ‚–é€†','å¿…éœ€':'å¿…é ˆ',
  'é ˆè¦':'éœ€è¦','æ¼«å»¶':'è”“å»¶','ç¶‘ç¶':'æ†ç¶','é£¢è’':'é¥‘è’','è­¦é†’':'å„†é†’',
  'å¤¢é¨':'å¤¢é­˜','è£œé¢¨':'æ•é¢¨','ä¸æŠ€ä¸æ±‚':'ä¸å¿®ä¸æ±‚','æ—¥æ¼¸å¥½è½‰':'æ—¥è¦‹å¥½è½‰','æ¦»é™·':'å¡Œé™·',
  'è¦ç•«':'è¦åŠƒ','ä¼ç•«':'ä¼åŠƒ'
};

/* =========================================================
   B) ç¶“æ–‡æ ¼å¼ï¼šæ²¿ç”¨ä½ åŸæœ¬ã€Œæ›¸å·ç°¡ç¨±ã€ç¿’æ…£
   ========================================================= */
const bookAbbreviations = {
  'å‰µä¸–è¨˜':'å‰µ','å‡ºåŸƒåŠè¨˜':'å‡º','åˆ©æœªè¨˜':'åˆ©','æ°‘æ•¸è¨˜':'æ°‘','ç”³å‘½è¨˜':'ç”³',
  'ç´„æ›¸äºè¨˜':'æ›¸','å£«å¸«è¨˜':'å£«','è·¯å¾—è¨˜':'å¾—','æ’’æ¯è€³è¨˜ä¸Š':'æ’’ä¸Š','æ’’æ¯è€³è¨˜ä¸‹':'æ’’ä¸‹',
  'åˆ—ç‹ç´€ä¸Š':'ç‹ä¸Š','åˆ—ç‹ç´€ä¸‹':'ç‹ä¸‹','æ­·ä»£å¿—ä¸Š':'ä»£ä¸Š','æ­·ä»£å¿—ä¸‹':'ä»£ä¸‹','ä»¥æ–¯æ‹‰è¨˜':'æ‹‰',
  'å°¼å¸Œç±³è¨˜':'å°¼','ä»¥æ–¯å¸–è¨˜':'æ–¯','ç´„ä¼¯è¨˜':'ä¼¯','è©©ç¯‡':'è©©','ç®´è¨€':'ç®´',
  'å‚³é“æ›¸':'å‚³','é›…æ­Œ':'æ­Œ','ä»¥è³½äºæ›¸':'è³½','è€¶åˆ©ç±³æ›¸':'è€¶','è€¶åˆ©ç±³å“€æ­Œ':'å“€',
  'ä»¥è¥¿çµæ›¸':'çµ','ä½†ä»¥ç†æ›¸':'ä½†','ä½•è¥¿é˜¿æ›¸':'ä½•','ç´„ç¥æ›¸':'ç¥','é˜¿æ‘©å¸æ›¸':'æ‘©',
  'ä¿„å·´åº•äºæ›¸':'ä¿„','ç´„æ‹¿æ›¸':'æ‹¿','å½Œè¿¦æ›¸':'å½Œ','é‚£é´»æ›¸':'é´»','å“ˆå·´è°·æ›¸':'å“ˆ',
  'è¥¿ç•ªé›…æ›¸':'ç•ª','å“ˆè©²æ›¸':'è©²','æ’’è¿¦åˆ©äºæ›¸':'äº','ç‘ªæ‹‰åŸºæ›¸':'ç‘ª',
  'é¦¬å¤ªç¦éŸ³':'å¤ª','é¦¬å¯ç¦éŸ³':'å¯','è·¯åŠ ç¦éŸ³':'è·¯','ç´„ç¿°ç¦éŸ³':'ç´„','ä½¿å¾’è¡Œå‚³':'å¾’',
  'ç¾…é¦¬æ›¸':'ç¾…','å“¥æ—å¤šå‰æ›¸':'æ—å‰','å“¥æ—å¤šå¾Œæ›¸':'æ—å¾Œ','åŠ æ‹‰å¤ªæ›¸':'åŠ ','ä»¥å¼—æ‰€æ›¸':'å¼—',
  'è…“ç«‹æ¯”æ›¸':'è…“','æ­Œç¾…è¥¿æ›¸':'è¥¿','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'å¸–å‰','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'å¸–å¾Œ','ææ‘©å¤ªå‰æ›¸':'æå‰',
  'ææ‘©å¤ªå¾Œæ›¸':'æå¾Œ','æå¤šæ›¸':'å¤š','è…“åˆ©é–€æ›¸':'é–€','å¸Œä¼¯ä¾†æ›¸':'ä¾†','é›…å„æ›¸':'é›…',
  'å½¼å¾—å‰æ›¸':'å½¼å‰','å½¼å¾—å¾Œæ›¸':'å½¼å¾Œ','ç´„ç¿°ä¸€æ›¸':'ç´„ä¸€','ç´„ç¿°äºŒæ›¸':'ç´„äºŒ','ç´„ç¿°ä¸‰æ›¸':'ç´„ä¸‰',
  'çŒ¶å¤§æ›¸':'çŒ¶','å•Ÿç¤ºéŒ„':'å•Ÿ',
  'é¦¬å¤ª':'å¤ª','é¦¬å¯':'å¯','è·¯åŠ ':'è·¯','ç´„ç¿°':'ç´„'
};

/* =========================================================
   C) SoonSoonBible çš„ bookMapï¼ˆç”¨ä¾†è§£æ å¤ª1.1ï¼‰
   - é€™è£¡åªè¦èƒ½æŠŠã€Œå¤ªã€æ˜ å°„åˆ° Mat é€™ç¨® CSV book code å°±è¡Œ
   ========================================================= */
const bookMap = {
  // èˆŠç´„
  'å‰µ':'Gen','å‰µä¸–':'Gen','å‰µä¸–è¨˜':'Gen',
  'å‡º':'Exo','å‡ºåŸƒåŠ':'Exo','å‡ºåŸƒåŠè¨˜':'Exo',
  'åˆ©':'Lev','åˆ©æœª':'Lev','åˆ©æœªè¨˜':'Lev',
  'æ°‘':'Num','æ°‘æ•¸':'Num','æ°‘æ•¸è¨˜':'Num',
  'ç”³':'Deu','ç”³å‘½':'Deu','ç”³å‘½è¨˜':'Deu',
  'æ›¸':'Jos','ç´„æ›¸äº':'Jos','ç´„æ›¸äºè¨˜':'Jos',
  'å£«':'Jug','å£«å¸«':'Jug','å£«å¸«è¨˜':'Jug',
  'å¾—':'Rut','è·¯å¾—':'Rut','è·¯å¾—è¨˜':'Rut',
  'æ’’ä¸Š':'1Sa','æ’’æ¯è€³ä¸Š':'1Sa','æ’’æ¯è€³è¨˜ä¸Š':'1Sa',
  'æ’’ä¸‹':'2Sa','æ’’æ¯è€³ä¸‹':'2Sa','æ’’æ¯è€³è¨˜ä¸‹':'2Sa',
  'ç‹ä¸Š':'1Ki','åˆ—ç‹ä¸Š':'1Ki','åˆ—ç‹è¨˜ä¸Š':'1Ki',
  'ç‹ä¸‹':'2Ki','åˆ—ç‹ä¸‹':'2Ki','åˆ—ç‹è¨˜ä¸‹':'2Ki',
  'ä»£ä¸Š':'1Ch','æ­·ä»£ä¸Š':'1Ch','æ­·ä»£å¿—ä¸Š':'1Ch',
  'ä»£ä¸‹':'2Ch','æ­·ä»£ä¸‹':'2Ch','æ­·ä»£å¿—ä¸‹':'2Ch',
  'æ‹‰':'Ezr','ä»¥æ–¯æ‹‰':'Ezr','ä»¥æ–¯æ‹‰è¨˜':'Ezr',
  'å°¼':'Neh','å°¼å¸Œç±³':'Neh','å°¼å¸Œç±³è¨˜':'Neh',
  'æ–¯':'Est','ä»¥æ–¯å¸–':'Est','ä»¥æ–¯å¸–è¨˜':'Est',
  'ä¼¯':'Job','ç´„ä¼¯':'Job','ç´„ä¼¯è¨˜':'Job',
  'è©©':'Psm','è©©ç¯‡':'Psm',
  'ç®´':'Pro','ç®´è¨€':'Pro',
  'å‚³':'Ecc','å‚³é“':'Ecc','å‚³é“æ›¸':'Ecc',
  'æ­Œ':'Son','é›…æ­Œ':'Son',
  'è³½':'Isa','ä»¥è³½äº':'Isa','ä»¥è³½äºæ›¸':'Isa',
  'è€¶':'Jer','è€¶åˆ©ç±³':'Jer','è€¶åˆ©ç±³æ›¸':'Jer',
  'å“€':'Lam','è€¶åˆ©ç±³å“€':'Lam','è€¶åˆ©ç±³å“€æ­Œ':'Lam',
  'çµ':'Eze','ä»¥è¥¿çµ':'Eze','ä»¥è¥¿çµæ›¸':'Eze',
  'ä½†':'Dan','ä½†ä»¥ç†':'Dan','ä½†ä»¥ç†æ›¸':'Dan',
  'ä½•':'Hos','ä½•è¥¿é˜¿':'Hos','ä½•è¥¿é˜¿æ›¸':'Hos',
  'ç¥':'Joe','ç´„ç¥':'Joe','ç´„ç¥æ›¸':'Joe',
  'æ‘©':'Amo','é˜¿æ‘©å¸':'Amo','é˜¿æ‘©å¸æ›¸':'Amo',
  'ä¿„':'Oba','ä¿„å·´åº•äº':'Oba','ä¿„å·´åº•äºæ›¸':'Oba',
  'æ‹¿':'Jon','ç´„æ‹¿':'Jon','ç´„æ‹¿æ›¸':'Jon',
  'å½Œ':'Mic','å½Œè¿¦':'Mic','å½Œè¿¦æ›¸':'Mic',
  'é´»':'Nah','é‚£é´»':'Nah','é‚£é´»æ›¸':'Nah',
  'å“ˆ':'Hab','å“ˆå·´è°·':'Hab','å“ˆå·´è°·æ›¸':'Hab',
  'ç•ª':'Zep','è¥¿ç•ªé›…':'Zep','è¥¿ç•ªé›…æ›¸':'Zep',
  'è©²':'Hag','å“ˆè©²':'Hag','å“ˆè©²æ›¸':'Hag',
  'äº':'Zec','æ’’è¿¦åˆ©äº':'Zec','æ’’è¿¦åˆ©äºæ›¸':'Zec',
  'ç‘ª':'Mal','ç‘ªæ‹‰åŸº':'Mal','ç‘ªæ‹‰åŸºæ›¸':'Mal',
  // æ–°ç´„
  'å¤ª':'Mat','é¦¬å¤ª':'Mat','é¦¬å¤ªç¦éŸ³':'Mat',
  'å¯':'Mak','é¦¬å¯':'Mak','é¦¬å¯ç¦éŸ³':'Mak',
  'è·¯':'Luk','è·¯åŠ ':'Luk','è·¯åŠ ç¦éŸ³':'Luk',
  'ç´„':'Jhn','ç´„ç¿°':'Jhn','ç´„ç¿°ç¦éŸ³':'Jhn',
  'å¾’':'Act','ä½¿å¾’':'Act','ä½¿å¾’è¡Œå‚³':'Act',
  'ç¾…':'Rom','ç¾…é¦¬':'Rom','ç¾…é¦¬æ›¸':'Rom',
  'æ—å‰':'1Co','å“¥æ—å¤šå‰':'1Co','å“¥æ—å¤šå‰æ›¸':'1Co',
  'æ—å¾Œ':'2Co','å“¥æ—å¤šå¾Œ':'2Co','å“¥æ—å¤šå¾Œæ›¸':'2Co',
  'åŠ ':'Gal','åŠ æ‹‰å¤ª':'Gal','åŠ æ‹‰å¤ªæ›¸':'Gal',
  'å¼—':'Eph','ä»¥å¼—æ‰€':'Eph','ä»¥å¼—æ‰€æ›¸':'Eph',
  'è…“':'Phl','è…“ç«‹æ¯”':'Phl','è…“ç«‹æ¯”æ›¸':'Phl',
  'è¥¿':'Col','æ­Œç¾…è¥¿':'Col','æ­Œç¾…è¥¿æ›¸':'Col',
  'å¸–å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'1Ts',
  'å¸–å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'2Ts',
  'æå‰':'1Ti','ææ‘©å¤ªå‰':'1Ti','ææ‘©å¤ªå‰æ›¸':'1Ti',
  'æå¾Œ':'2Ti','ææ‘©å¤ªå¾Œ':'2Ti','ææ‘©å¤ªå¾Œæ›¸':'2Ti',
  'å¤š':'Tit','æå¤š':'Tit','æå¤šæ›¸':'Tit',
  'é–€':'Phm','è…“åˆ©é–€':'Phm','è…“åˆ©é–€æ›¸':'Phm',
  'ä¾†':'Heb','å¸Œä¼¯ä¾†':'Heb','å¸Œä¼¯ä¾†æ›¸':'Heb',
  'é›…':'Jas','é›…å„':'Jas','é›…å„æ›¸':'Jas',
  'å½¼å‰':'1Pe','å½¼å¾—å‰':'1Pe','å½¼å¾—å‰æ›¸':'1Pe',
  'å½¼å¾Œ':'2Pe','å½¼å¾—å¾Œ':'2Pe','å½¼å¾—å¾Œæ›¸':'2Pe',
  'ç´„ä¸€':'1Jn','ç´„ç¿°ä¸€':'1Jn','ç´„ç¿°ä¸€æ›¸':'1Jn',
  'ç´„äºŒ':'2Jn','ç´„ç¿°äºŒ':'2Jn','ç´„ç¿°äºŒæ›¸':'2Jn',
  'ç´„ä¸‰':'3Jn','ç´„ç¿°ä¸‰':'3Jn','ç´„ç¿°ä¸‰æ›¸':'3Jn',
  'çŒ¶':'Jud','çŒ¶å¤§':'Jud','çŒ¶å¤§æ›¸':'Jud',
  'å•Ÿ':'Rev','å•Ÿç¤º':'Rev','å•Ÿç¤ºéŒ„':'Rev'
};

const sortedBookNames = Object.keys(bookMap).sort((a,b)=>b.length-a.length);

/* =========================================================
   D) ç« æ•¸è½‰ä¸­æ–‡ï¼ˆæ²¿ç”¨ä½ åŸæœ¬ï¼‰
   ========================================================= */
function chineseToNumber(chineseNum){
  const cnNums={'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9};
  const cnUnits={'å':10,'ç™¾':100,'åƒ':1000,'è¬':10000};
  if (/^\d+$/.test(chineseNum)) return parseInt(chineseNum,10);

  let total=0, section=0, number=0, unitOps=false;
  for(let i=0;i<chineseNum.length;i++){
    const c=chineseNum.charAt(i);
    if(cnNums.hasOwnProperty(c)){
      number=cnNums[c]; unitOps=false;
    }else if(cnUnits.hasOwnProperty(c)){
      let unit=cnUnits[c];
      if(unit===10 && number===0 && !unitOps) number=1;
      section=(section+number)*unit;
      if(unit>=10000){ total+=section; section=0; }
      else { total+=section; section=0; }
      number=0; unitOps=true;
    }else if(/\d/.test(c)){ number=parseInt(c,10); }
  }
  if(!unitOps) total+=number;
  if(total===0 && chineseNum.startsWith('å')){
    let temp=10;
    if(chineseNum.length>1) temp+=cnNums[chineseNum[1]]||0;
    return temp;
  }
  return total>0?total:number;
}
function numberToChinese(num){
  const cnNums=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  const cnUnits=['','å','ç™¾','åƒ'];
  if(num===0) return 'é›¶';
  if(num===10) return 'å';
  if(num>10 && num<20) return 'å'+cnNums[num%10];
  let str='', s=num.toString(), len=s.length;
  for(let i=0;i<len;i++){
    let n=parseInt(s.charAt(len-i-1));
    let digit=cnNums[n], unit=cnUnits[i];
    if(n!==0) str=digit+unit+str;
    else if(str.length>0 && !str.startsWith('é›¶')) str='é›¶'+str;
  }
  return str.replace(/é›¶+$/,'');
}

/* =========================================================
   E) ç¶“æ–‡è³‡æ–™è¼‰å…¥ï¼ˆbible.csv in same folderï¼‰
   ========================================================= */
let bibleData=[];
let bibleReady=false;
let openccReady=false;
let t2s=null, s2t=null;

async function initOpenCC(){
  try{
    // OpenCC.Converter é è¨­ from:tw to:cnï¼›æˆ‘å€‘è¦é¡¯å¼æŒ‡å®šï¼Œé¿å…èª¤ç”¨ twp ç‰‡èªæ¨¡å¼
    t2s = OpenCC.Converter({ from:'tw', to:'cn' });
    s2t = OpenCC.Converter({ from:'cn', to:'tw' });
    openccReady=true;
  }catch(e){
    openccReady=false;
    console.warn('OpenCC init fail', e);
  }
}

function parseCSVInWorker(csvText){
  return new Promise((resolve)=>{
    const workerCode = `
      self.onmessage = (e) => {
        const lines = e.data.split(/\\r?\\n/);
        const out = [];
        for (let i=1;i<lines.length;i++){
          const row = lines[i]; if(!row) continue;
          const parts = row.split(',');
          if(parts.length>=4){
            const c = parseInt(parts[1].trim());
            const v = parseInt(parts[2].trim());
            if(!isNaN(c) && !isNaN(v)){
              out.push({
                book: parts[0].trim(),
                chapter: c,
                verse: v,
                text: parts.slice(3).join(',').trim(),
                id: c*1000 + v
              });
            }
          }
        }
        postMessage(out);
      };
    `;
    const blob=new Blob([workerCode],{type:'application/javascript'});
    const worker=new Worker(URL.createObjectURL(blob));
    worker.onmessage=(ev)=>{ bibleData=ev.data||[]; worker.terminate(); resolve(); };
    worker.postMessage(csvText);
  });
}

async function loadBibleCSV(){
  const outputEl=document.getElementById('output');
  try{
    const res = await fetch(`./bible.csv?v=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=(await res.text()).replace(/^\uFEFF/,'');
    await parseCSVInWorker(text);
    bibleReady=true;
  }catch(e){
    bibleReady=false;
    outputEl.innerHTML = `<span style="color:#b91c1c; font-weight:800;">âš  bible.csv è¼‰å…¥å¤±æ•—</span><br><span style="color:#666;">è«‹ç¢ºèª bible.csv å’Œ index.html åœ¨åŒä¸€å±¤ï¼Œä¸” CSV æ ¼å¼èˆ‡ SoonSoonBible ä¸€è‡´ã€‚</span>`;
  }
}

/* =========================================================
   F) ç¶“æ–‡å¼•ç”¨è§£æï¼ˆæ‘˜è‡ªä½ çš„ SoonSoonBible æ€è·¯ï¼Œç°¡åŒ–ç‰ˆï¼‰
   ========================================================= */
function cnToNum(str){
  if(!str) return null;
  if(/^\d+$/.test(str)) return parseInt(str,10);
  const map={'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'ç™¾':100};
  if(!/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]/.test(str)) return null;
  let num=0,temp=0;
  for(let i=0;i<str.length;i++){
    const n=map[str[i]];
    if(n===undefined) continue;
    if(n===100){ num += (temp===0?1:temp)*100; temp=0; }
    else if(n===10){ num += (temp===0?1:temp)*10; temp=0; }
    else { temp=n; }
  }
  num+=temp; return num;
}

function parseRefPart(str, defaultBook, defaultChapter){
  let bookKey=defaultBook;
  let remain=str;
  let hasBookInStr=false;
  for(const key of sortedBookNames){
    if(str.startsWith(key)){
      bookKey=bookMap[key];
      remain=str.substring(key.length);
      hasBookInStr=true;
      break;
    }
  }
  remain=remain.replace(/[.ï¼ã€‚,ï¼Œ]/g,':');
  let c,v;
  let splitIdx=-1;
  const isDigit=(ch)=>/[0-9]/.test(ch);
  const isCnDigit=(ch)=>/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]/.test(ch);
  for(let i=0;i<remain.length-1;i++){
    if(isCnDigit(remain[i]) && isDigit(remain[i+1])){ splitIdx=i+1; break; }
  }

  if(remain.includes(':')){
    const p=remain.split(':');
    c = cnToNum(p[0]) || parseInt(p[0]);
    v = cnToNum(p[1]) || parseInt(p[1]);
  }else if(splitIdx!==-1){
    c = cnToNum(remain.substring(0,splitIdx));
    v = parseInt(remain.substring(splitIdx));
  }else{
    const val = cnToNum(remain) || parseInt(remain);
    if(defaultChapter && !hasBookInStr){ c=defaultChapter; v=val; }
    else { c=val; v=null; }
  }

  return {
    book: bookKey,
    chapter: c,
    verse: v,
    id: (c && v) ? (c*1000+v) : null,
    isChapterOnly: (c && !v)
  };
}

function parseSearchQuery(input){
  let clean=input.replace(/\s+/g,'')
                 .replace(/[.ï¼ã€‚,ï¼Œ]/g,':')
                 .replace(/[â€”~ï½]/g,'-');
  clean=clean.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾])(\d)/g,'$1:$2');

  if(clean.includes('-')){
    const [startStr,endStr]=clean.split('-');
    const startObj=parseRefPart(startStr,null,null);
    if(!startObj.chapter) return null;
    const contextChap = startObj.verse ? startObj.chapter : null;
    const endObj=parseRefPart(endStr,startObj.book,contextChap);
    if(!endObj.book) endObj.book=startObj.book;

    let startId=startObj.id;
    let endId=0;
    if(endObj.verse) endId=endObj.chapter*1000+endObj.verse;
    else endId=endObj.chapter*1000+999;
    if(startObj.isChapterOnly) startId=startObj.chapter*1000;

    return { type:'range', book:startObj.book, startId, endId };
  }else{
    const obj=parseRefPart(clean,null,null);
    return { type:'single', book:obj.book, chapter:obj.chapter, verse:obj.verse };
  }
}

/* =========================================================
   G) ç¶“æ–‡æŸ¥æ‰¾ + å½¢æˆæ’å…¥æ–‡å­—
   ========================================================= */
function bookCodeToShort(bookCode){
  // åæŸ¥æœ€çŸ­ keyï¼ˆåå‘ã€Œå¤ªã€ã€Œç´„ã€é€™ç¨®ï¼‰
  const keys = Object.keys(bookMap).filter(k=>bookMap[k]===bookCode);
  if(!keys.length) return bookCode;
  keys.sort((a,b)=>a.length-b.length);
  return keys[0];
}
function formatRefShort(bookCode, chapter, verse){
  const short=bookCodeToShort(bookCode);
  const chapChi=numberToChinese(parseInt(chapter));
  const vStr = (verse!==null && verse!==undefined) ? String(verse) : '';
  return `ï¼ˆ${short}${chapChi}${vStr}ï¼‰`;
}

function findVersesByQuery(query){
  if(!bibleReady || !query) return [];
  if(query.type==='range'){
    return bibleData.filter(e=>e.book===query.book && e.id>=query.startId && e.id<=query.endId);
  }
  // single
  if(!query.book || !query.chapter) return [];
  const c=parseInt(query.chapter);
  if(query.verse===null || query.verse===undefined){
    // æ•´ç« ï¼šä½ å¦‚æœä¸æƒ³æ•´ç« æ’å…¥ï¼Œå°±æ”¹æˆåªå›ç©º
    return bibleData.filter(e=>e.book===query.book && e.chapter===c);
  }
  const v=parseInt(query.verse);
  return bibleData.filter(e=>e.book===query.book && e.chapter===c && e.verse===v);
}

function buildInsertText(verses){
  if(!verses.length) return '';
  // ä½ å¯æ”¹æˆåªæ’å…¥ç¶“æ–‡ã€ä¸å¸¶ refï¼›é€™è£¡æˆ‘é è¨­ã€Œç¶“æ–‡ï¼‹refã€æ¯”è¼ƒè€ç”¨
  return verses.map(e=>`${e.text} ${formatRefShort(e.book, e.chapter, e.verse)}`).join('\n');
}

/* =========================================================
   H) å¯«ä½œå€ï¼šè‡ªå‹•åµæ¸¬å¼•ç”¨ â†’ é¡¯ç¤ºé è¦½æµ®çª—
   ========================================================= */
let lastDetected = null; // { token, start, end, verses, insertText, showRef }

function getLastTokenNearCursor(text, cursor){
  // å¾€å·¦æ‰¾ä¸€æ®µåƒã€Œå¤ª1.1ã€çš„ tokenï¼ˆé‡åˆ°ç©ºç™½æˆ–æ›è¡Œå°±åœï¼‰
  let i = cursor - 1;
  while(i>=0 && !/\s/.test(text[i])) i--;
  const start=i+1;
  let j = cursor;
  while(j<text.length && !/\s/.test(text[j])) j++;
  const end=j;
  const token=text.slice(start,end);
  return { token, start, end };
}

function maybeDetectVerse(){
  const autoOn=document.getElementById('autoVerseToggle').checked;
  if(!autoOn) return;

  const ta=document.getElementById('inputText');
  const text=ta.value;
  const cursor=ta.selectionStart;

  const { token, start, end } = getLastTokenNearCursor(text, cursor);
  if(!token || token.length < 3) { closeVersePop(); return; }

  // å¦‚æœ token åŒ…äº†æ‹¬è™Ÿï¼Œä¹Ÿè©¦è‘—å‰æ‰
  const cleaned = token.replace(/[()ï¼ˆï¼‰\[\]]/g,'').trim();
  const q=parseSearchQuery(cleaned);
  if(!q) { closeVersePop(); return; }

  // åªå°ã€Œå–®ç¯€ã€æˆ–ã€Œå€é–“ã€æç¤ºï¼›æ•´ç« æœƒå¾ˆé•·ï¼Œæ€•ä½ èª¤æ’
  const verses=findVersesByQuery(q).slice(0, 30); // é è¦½æœ€å¤š 30 ç¯€
  if(!verses.length) { closeVersePop(); return; }

  // è‹¥æ˜¯æ•´ç« ï¼ˆverse=nullï¼‰å°±ä¸è‡ªå‹•è·³ï¼Œé¿å…ä½ æ‰“ã€Œå¤ª1ã€å®ƒçˆ†å‡ºä¸€æ•´ç« 
  if(q.type==='single' && (q.verse===null || q.verse===undefined)) { closeVersePop(); return; }

  const insertText = buildInsertText(verses);
  lastDetected = { token, cleaned, start, end, verses, insertText };

  const pop=document.getElementById('versePop');
  const refEl=document.getElementById('versePopRef');
  const txtEl=document.getElementById('versePopText');

  const first=verses[0];
  refEl.textContent = formatRefShort(first.book, first.chapter, first.verse);
  txtEl.textContent = insertText;

  pop.classList.add('show');
}

function closeVersePop(){
  document.getElementById('versePop').classList.remove('show');
  lastDetected=null;
}

function insertVerse(){
  if(!lastDetected) return;
  const ta=document.getElementById('inputText');
  const replaceOn=document.getElementById('replaceRefToggle').checked;

  const insertText = lastDetected.insertText;

  const before = ta.value.slice(0, replaceOn ? lastDetected.start : ta.selectionStart);
  const after  = ta.value.slice(replaceOn ? lastDetected.end : ta.selectionEnd);

  const mid = (before && !before.endsWith('\n') && before.length>0) ? '' : '';
  const newText = before + insertText + after;

  ta.value = newText;

  // å°‡æ¸¸æ¨™æ”¾åœ¨æ’å…¥å…§å®¹å¾Œé¢
  const pos = (before + insertText).length;
  ta.focus();
  ta.setSelectionRange(pos, pos);

  closeVersePop();
  triggerAutosave();
  processText();
}

/* =========================================================
   I) æ ¡ç¨¿ï¼šé è¦½ï¼ˆä¿ç•™ä½ åŸæœ¬ã€Œæ¨™è¨˜éŒ¯å­—ã€é¢¨æ ¼ï¼‰
   ========================================================= */
function applyHardRulesPlain(text){
  for(const [from,to] of hardRules){
    text = text.split(from).join(to);
  }
  return text;
}

function applyTyposPlain(text){
  // å…ˆé•·è©å†çŸ­è©ï¼Œé¿å…å±€éƒ¨è¦†è“‹
  const keys = Object.keys(typoCorrections).sort((a,b)=>b.length-a.length);
  for(const k of keys){
    text = text.split(k).join(typoCorrections[k]);
  }
  return text;
}

function getCleanFixedText(text){
  // å…ˆç¡¬è¦å‰‡ï¼Œå†éŒ¯åˆ¥å­—ï¼ˆä½ å¯ä»¥èª¿é †åºï¼‰
  text = applyHardRulesPlain(text);
  text = applyTyposPlain(text);
  return text;
}

function processText(){
  const inputEl=document.getElementById('inputText');
  const outputEl=document.getElementById('output');
  let text=inputEl.value;

  if(!text){
    outputEl.innerHTML='<span style="color:#999;">ç­‰å¾…è¼¸å…¥...</span>';
    return;
  }

  // é è¦½ï¼šå…ˆè·‘ã€Œç¡¬è¦å‰‡ã€èˆ‡ã€ŒéŒ¯åˆ¥å­—ã€ä½†ä¿ç•™æ¨™ç¤ºï¼ˆç´…/é»ƒï¼‰
  let preview=text;

  // å…ˆç¡¬è¦å‰‡ä¹Ÿæ¨™ç¤ºï¼ˆç”¨åŒä¸€ç¨®æ¨™ç¤ºæ–¹å¼ï¼‰
  for(const [from,to] of hardRules){
    const re=new RegExp(from.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview = preview.replace(re, `<span class="highlight-typo">${from}</span><span class="highlight-correction">${to}</span>`);
  }
  for(let typo in typoCorrections){
    const correction=typoCorrections[typo];
    const re=new RegExp(typo.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview=preview.replace(re, `<span class="highlight-typo">${typo}</span><span class="highlight-correction">${correction}</span>`);
  }

  // ç¶“æ–‡å¼•ç”¨ï¼šåªæŠŠã€Œï¼ˆ...ï¼‰ã€ä¸­çœ‹èµ·ä¾†åƒç¶“æ–‡çš„åšé«˜äº®ï¼ˆä½ åŸæœ¬é‚è¼¯ï¼‰
  preview = preview.replace(/ï¼ˆ([^ï¼‰]+)ï¼‰/g, function(match, content){
    let foundBook=null, bookAbbr='';
    let sortedBooks=Object.keys(bookAbbreviations).sort((a,b)=>b.length-a.length);
    for(let book of sortedBooks){
      if(content.startsWith(book)){
        foundBook=book;
        bookAbbr=bookAbbreviations[book];
        break;
      }
    }
    if(!foundBook) return match;
    let remain=content.substring(foundBook.length).trim();
    let cleanRef=remain.replace(/[ç« ç¯‡ç¯€\s]/g,':').replace(/[:ï¼š.ï¼]+/g,':');
    let parts=cleanRef.split(':').filter(p=>p);
    if(parts.length===0) return match;

    let chapter=parts[0];
    let verse=parts.length>1 ? parts[1] : '';
    let chapterNum=chineseToNumber(chapter);
    let chapterChi=numberToChinese(chapterNum);

    let verseStr='';
    if(verse){
      if(verse.includes('-')||verse.includes('ï¼')||verse.includes('è‡³')){
        let vParts=verse.split(/[-ï¼è‡³]/);
        let v1=chineseToNumber(vParts[0]);
        let v2=chineseToNumber(vParts[1]);
        verseStr=`${v1}-${v2}`;
      }else{
        verseStr=chineseToNumber(verse).toString();
      }
    }
    let newRef=`ï¼ˆ${bookAbbr}${chapterChi}${verseStr}ï¼‰`;
    return `<span class="highlight-scripture">${newRef}</span>`;
  });

  preview = preview.replace(/\n/g,'<br>');
  outputEl.innerHTML=preview;
}

function applyFixesToInput(){
  const ta=document.getElementById('inputText');
  const fixed=getCleanFixedText(ta.value);
  ta.value=fixed;
  triggerAutosave();
  processText();
}

/* =========================================================
   J) ç¹ç°¡è½‰æ›ï¼ˆOpenCCï¼‰
   - ä½ è¦æ±‚ï¼šç¹ç°¡ã€Œæ–‡å­—å°æ–‡å­—ã€ï¼Œä¸è¦è‡ªä½œä¸»å¼µæ”¹åå­—
   - æ‰€ä»¥æˆ‘å€‘ç”¨ tw<->cnï¼Œä¸ç”¨ twpï¼ˆç‰‡èªæ¨¡å¼ï¼‰
   ========================================================= */
function toSimplified(){
  if(!openccReady){
    alert('OpenCC å°šæœªå°±ç·’ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ– CDN è¼‰å…¥å¤±æ•—ï¼‰ã€‚');
    return;
  }
  const ta=document.getElementById('inputText');
  // å…ˆè½‰ï¼Œå†å¥—ä½ ç¡¬è¦å‰‡/éŒ¯åˆ¥å­—ï¼ˆä½ è¦çš„ã€Œå°â†’è‡ºã€ã€Œä¸Šå¸â†’ç¥ã€ä¹Ÿæœƒç¹¼çºŒä¿æŒï¼‰
  let out=t2s(ta.value);
  out=getCleanFixedText(out);
  ta.value=out;
  triggerAutosave();
  processText();
}
function toTraditional(){
  if(!openccReady){
    alert('OpenCC å°šæœªå°±ç·’ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ– CDN è¼‰å…¥å¤±æ•—ï¼‰ã€‚');
    return;
  }
  const ta=document.getElementById('inputText');
  let out=s2t(ta.value);
  out=getCleanFixedText(out);
  ta.value=out;
  triggerAutosave();
  processText();
}

/* =========================================================
   K) å‰ªè²¼ç°¿ï¼šè¤‡è£½/å‰ªä¸‹/è²¼ä¸Š
   ========================================================= */
function copyInput(){
  const ta=document.getElementById('inputText');
  navigator.clipboard.writeText(ta.value).then(()=>alert('å·²è¤‡è£½å¯«ä½œå€å…§å®¹')).catch(()=>alert('è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™ï¼‰'));
}
function cutText(){
  const ta=document.getElementById('inputText');
  const start=ta.selectionStart, end=ta.selectionEnd;
  const selected = ta.value.slice(start,end);
  if(!selected){ alert('å…ˆé¸å–ä¸€æ®µæ–‡å­—å†å‰ªä¸‹'); return; }
  navigator.clipboard.writeText(selected).then(()=>{
    ta.value = ta.value.slice(0,start) + ta.value.slice(end);
    ta.setSelectionRange(start,start);
    triggerAutosave();
    processText();
  }).catch(()=>alert('å‰ªä¸‹å¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™ï¼‰'));
}
function pasteText(){
  const ta=document.getElementById('inputText');
  navigator.clipboard.readText().then(txt=>{
    const start=ta.selectionStart, end=ta.selectionEnd;
    ta.value = ta.value.slice(0,start) + txt + ta.value.slice(end);
    const pos=start+txt.length;
    ta.setSelectionRange(pos,pos);
    triggerAutosave();
    processText();
  }).catch(()=>alert('è²¼ä¸Šå¤±æ•—ï¼ˆç€è¦½å™¨æ¬Šé™æˆ–é HTTPSï¼‰'));
}

/* =========================================================
   L) å³å´è¤‡è£½ï¼ˆè¼¸å‡ºæ˜¯ HTMLï¼Œéœ€è½‰ç´”æ–‡å­—ï¼‰
   ========================================================= */
function copyResult(){
  const outputEl=document.getElementById('output');
  let tempDiv=document.createElement('div');
  tempDiv.innerHTML=outputEl.innerHTML;
  // ç§»é™¤éŒ¯å­—åŸæ–‡ï¼Œåªç•™æ›´æ­£å¾Œ
  tempDiv.querySelectorAll('.highlight-typo').forEach(el=>el.remove());
  const finalCopyText=tempDiv.innerText;
  navigator.clipboard.writeText(finalCopyText).then(()=>alert('æ ¡ç¨¿çµæœï¼ˆç´”æ–‡å­—ï¼‰å·²è¤‡è£½')).catch(()=>alert('è¤‡è£½å¤±æ•—'));
}

/* =========================================================
   M) æ¸…ç©º
   ========================================================= */
function clearText(){
  if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')){
    document.getElementById('inputText').value='';
    document.getElementById('output').innerHTML='';
    localStorage.removeItem('writer_draft_v1');
    closeVersePop();
    setAutosaveBadge('å·²æ¸…ç©º', true);
  }
}

/* =========================================================
   N) è‡ªå‹•å­˜æª”ï¼šåƒä½ åœ¨ FB é‚£ç¨®ã€Œé‚Šæ‰“é‚Šä¿å­˜ã€çš„å®‰å…¨æ„Ÿ
   ========================================================= */
let autosaveTimer=null;
function setAutosaveBadge(text, danger=false){
  const b=document.getElementById('autosaveBadge');
  b.textContent=text;
  b.style.background = danger ? '#fee2e2' : '#f1f5f9';
  b.style.borderColor = danger ? '#fecaca' : '#e2e8f0';
  b.style.color = danger ? '#991b1b' : '#475569';
}
function triggerAutosave(){
  clearTimeout(autosaveTimer);
  autosaveTimer=setTimeout(()=>{
    const ta=document.getElementById('inputText');
    localStorage.setItem('writer_draft_v1', ta.value);
    const now=new Date();
    const hh=String(now.getHours()).padStart(2,'0');
    const mm=String(now.getMinutes()).padStart(2,'0');
    const ss=String(now.getSeconds()).padStart(2,'0');
    setAutosaveBadge(`å·²å­˜ ${hh}:${mm}:${ss}`);
  }, 250);
}

/* =========================================================
   O) åˆå§‹åŒ–ï¼šè¼‰å…¥è‰ç¨¿ã€è¼‰ CSVã€ç¶äº‹ä»¶
   ========================================================= */
window.addEventListener('load', async ()=>{
  await initOpenCC();
  await loadBibleCSV();

  const ta=document.getElementById('inputText');

  // æ¢å¾©è‰ç¨¿
  const saved=localStorage.getItem('writer_draft_v1');
  if(saved){
    ta.value=saved;
    setAutosaveBadge('å·²æ¢å¾©è‰ç¨¿');
  }else{
    setAutosaveBadge('æœªå­˜æª”');
  }

  // å³æ™‚æ ¡ç¨¿é è¦½ + autosave + ç¶“æ–‡åµæ¸¬
  ta.addEventListener('input', ()=>{
    triggerAutosave();
    processText();
    // ä½ æ‰“å­—åœä¸€ä¸‹æ‰åµæ¸¬ç¶“æ–‡ï¼ˆé¿å…ä¸€ç›´è·³ï¼‰
    clearTimeout(window.__verseDetectTimer);
    window.__verseDetectTimer=setTimeout(maybeDetectVerse, 220);
  });

  // æ¸¸æ¨™ç§»å‹•ä¹Ÿå¯ä»¥åµæ¸¬ï¼ˆä¾‹å¦‚ä½ å›é ­æ”¹å­—ï¼‰
  ta.addEventListener('keyup', (e)=>{
    if(e.key==='ArrowLeft' || e.key==='ArrowRight' || e.key==='ArrowUp' || e.key==='ArrowDown'){
      clearTimeout(window.__verseDetectTimer);
      window.__verseDetectTimer=setTimeout(maybeDetectVerse, 180);
    }
  });

  // å¿«æ·éµï¼šAlt+Enter æ’å…¥ç¶“æ–‡ã€Esc é—œé–‰æµ®çª—
  document.addEventListener('keydown', (e)=>{
    const popShown = document.getElementById('versePop').classList.contains('show');
    if(e.key==='Escape' && popShown){
      closeVersePop();
    }
    if(e.altKey && e.key==='Enter' && popShown){
      e.preventDefault();
      insertVerse();
    }
  });

  processText();
});

/* å°å¤–ï¼ˆHTML onclick ç”¨ï¼‰ */
window.processText=processText;
window.copyResult=copyResult;
window.clearText=clearText;
window.applyFixesToInput=applyFixesToInput;
window.toSimplified=toSimplified;
window.toTraditional=toTraditional;
window.cutText=cutText;
window.pasteText=pasteText;
window.copyInput=copyInput;
window.insertVerse=insertVerse;
window.closeVersePop=closeVersePop;
</script>
</body>
</html>
