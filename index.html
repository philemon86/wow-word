<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>éˆæ„Ÿå¯«æ‰‹ Mobile (å®Œæ•´é‚è¼¯ç‰ˆ)</title>

  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

  <style>
    :root {
      --primary: #007aff;
      --bg: #f2f2f7;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --border: #c6c6c8;
      --warn: #ff9500;
      --danger: #ff3b30;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0; background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; height: 100vh; overflow: hidden;
    }

    /* --- æ‰‹æ©Ÿç‰ˆ UI å…ƒä»¶ --- */
    
    /* é ‚éƒ¨å°èˆª */
    header {
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      padding: 12px 16px; border-bottom: 0.5px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; z-index: 100;
    }
    .brand { font-size: 17px; font-weight: 700; }
    .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e5e5ea; color: #8e8e93; }
    .status-badge.saving { background: var(--primary); color: white; }

    /* é ç±¤åˆ‡æ› (Tabs) */
    .tabs-nav {
      display: flex; padding: 10px 16px 0; background: var(--bg);
    }
    .tab-btn {
      flex: 1; padding: 8px; text-align: center; font-size: 14px; font-weight: 600;
      color: #8e8e93; border-bottom: 2px solid transparent; transition: 0.2s;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* å…§å®¹å®¹å™¨ */
    .viewport { flex: 1; position: relative; overflow: hidden; background: var(--card-bg); }
    .page { 
      position: absolute; inset: 0; display: none; flex-direction: column; 
      padding: 16px; overflow-y: auto; 
    }
    .page.active { display: flex; }

    /* è¼¸å…¥æ¡† */
    textarea {
      flex: 1; width: 100%; border: none; outline: none; resize: none;
      font-size: 17px; line-height: 1.6; padding-bottom: 40px; /* é ç•™ç©ºé–“çµ¦æµ®çª— */
    }

    /* é è¦½å€æ¨£å¼ (æ²¿ç”¨åŸæœ¬çš„é«˜äº®é‚è¼¯) */
    .highlight-scripture { background: #d1e7dd; color: #0f5132; padding: 0 2px; border-radius: 4px; font-weight: 700; }
    .highlight-typo { text-decoration: line-through; color: #8e8e93; margin-right: 2px; }
    .highlight-correction { background: #fff3cd; color: #b45309; font-weight: 700; padding: 0 4px; border-radius: 4px; }

    /* ç¶“æ–‡æµ®çª— (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆï¼šåº•éƒ¨ Toast) */
    .verse-pop {
      position: fixed; bottom: 80px; left: 16px; right: 16px;
      background: #1c1c1e; color: white; padding: 16px; border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: none; z-index: 200; transform: translateY(10px); opacity: 0;
      transition: 0.2s;
    }
    .verse-pop.show { display: block; transform: translateY(0); opacity: 1; }
    .pop-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .pop-ref { color: #60a5fa; font-weight: 700; }
    .pop-body { max-height: 120px; overflow-y: auto; font-size: 14px; opacity: 0.9; margin-bottom: 12px; line-height: 1.5; }
    .pop-actions { display: flex; gap: 8px; }
    
    /* åº•éƒ¨å·¥å…·åˆ— (å¯æ»‘å‹•) */
    .bottom-toolbar {
      padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.95); border-top: 0.5px solid var(--border);
      display: flex; gap: 10px; overflow-x: auto;
      scrollbar-width: none; /* Firefox Hidden */
    }
    .bottom-toolbar::-webkit-scrollbar { display: none; }
    
    .tool-btn {
      padding: 8px 14px; border-radius: 8px; border: 1px solid #e5e5ea;
      background: white; font-size: 13px; font-weight: 600; white-space: nowrap; flex-shrink: 0;
    }
    .tool-btn:active { background: #f2f2f7; }
    .btn-main { background: var(--primary); color: white; border: none; }
    .btn-danger { color: var(--danger); border-color: #fee2e2; background: #fff5f5; }

    /* é–‹é—œæ¨£å¼ */
    .toggle-group { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666; }
  </style>
</head>

<body>

  <header>
    <div class="brand">âœï¸ éˆæ„Ÿå¯«æ‰‹</div>
    <div id="autosaveBadge" class="status-badge">æº–å‚™å°±ç·’</div>
  </header>

  <div class="tabs-nav">
    <div class="tab-btn active" onclick="switchTab('edit')">ç·¨è¼¯å¯«ä½œ</div>
    <div class="tab-btn" onclick="switchTab('preview')">æ ¡ç¨¿é è¦½</div>
  </div>

  <div class="viewport">
    
    <div id="page-edit" class="page active">
      <textarea id="inputText" placeholder="åœ¨é€™è£¡å¯«ä½œ... è¼¸å…¥ã€Œå¤ª1.1ã€è©¦è©¦çœ‹ç¶“æ–‡å¿«æ’"></textarea>
      
      <div id="versePop" class="verse-pop">
        <div class="pop-header">
          <span id="versePopRef" class="pop-ref"></span>
          <span style="font-size:11px; opacity:0.6;">Alt+Enter æ’å…¥</span>
        </div>
        <div id="versePopText" class="pop-body">è¼‰å…¥ä¸­...</div>
        <div class="pop-actions">
          <button class="tool-btn btn-main" style="flex:1" onclick="insertVerse()">æ’å…¥ç¶“æ–‡</button>
          <button class="tool-btn" style="flex:1" onclick="closeVersePop()">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div id="page-preview" class="page">
      <div id="output" style="line-height: 1.8; font-size: 16px;"></div>
    </div>

  </div>

  <div class="bottom-toolbar">
    <button class="tool-btn btn-main" onclick="applyFixesToInput()">ğŸª„ ä¸€éµä¿®æ­£</button>
    <button class="tool-btn" onclick="toTraditional()">ç¹é«”</button>
    <button class="tool-btn" onclick="toSimplified()">ç°¡é«”</button>
    <button class="tool-btn" onclick="copyResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
    <button class="tool-btn btn-danger" onclick="clearText()">æ¸…ç©º</button>
    
    <div style="width:1px; height:20px; background:#ddd; margin:0 4px;"></div>
    <label class="toggle-group">
      <input type="checkbox" id="autoVerseToggle" checked> è‡ªå‹•åµæ¸¬
    </label>
    <label class="toggle-group">
      <input type="checkbox" id="replaceRefToggle" checked> å–ä»£å¼•ç”¨
    </label>
  </div>

<script>
/* =========================================================
   UI é‚è¼¯ï¼šè™•ç†æ‰‹æ©Ÿç‰ˆçš„åˆ†é åˆ‡æ›
   ========================================================= */
function switchTab(tabName) {
  // åˆ‡æ› Tab æ¨£å¼
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  if(tabName === 'edit') document.querySelectorAll('.tab-btn')[0].classList.add('active');
  if(tabName === 'preview') document.querySelectorAll('.tab-btn')[1].classList.add('active');

  // åˆ‡æ›é é¢é¡¯ç¤º
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById('page-' + tabName).classList.add('active');

  // å¦‚æœåˆ‡æ›åˆ°é è¦½ï¼ŒåŸ·è¡Œä¸€æ¬¡é‚è¼¯é‹ç®—
  if(tabName === 'preview') processText();
}

/* =========================================================
   æ ¸å¿ƒé‚è¼¯å€ (å®Œå…¨ä¿ç•™åŸå§‹ä»£ç¢¼)
   ========================================================= */

// A) éŒ¯åˆ¥å­—èˆ‡è¦å‰‡åº« (å®Œæ•´ä¿ç•™)
const hardRules = [
  ['ä¸Šå¸', 'ç¥'],
  ['å°', 'è‡º'],
];

const typoCorrections = {
  'å®‰ç¥¥':'å®‰è©³','å°ç£':'è‡ºç£','è¬›å°':'è¬›è‡º','å§Šå¦¹':'å§å¦¹','è£é¢':'è£¡é¢',
  'ç”šéº¼':'ä»€éº¼','ç§˜å¯†':'ç¥•å¯†','å¥§ç§˜':'å¥§ç¥•','æŒ‰æ­¥å°±ç­':'æŒ‰éƒ¨å°±ç­','ä¸æ˜ç©¶ç†':'ä¸æ˜å°±è£¡',
  'æ·¬ç·´':'æ·¬éŠ','å€Ÿæ©Ÿ':'è—‰æ©Ÿ','æ‹¼å‘½':'æ‹šå‘½','ç…é‚£':'å‰é‚£','èº«ä»½':'èº«åˆ†',
  'ç†Ÿæ»':'ç†Ÿç¨”','ç„¡æ‰€é©äº‹':'ç„¡æ‰€äº‹äº‹','æ’’é¦¬åˆ©äº':'æ’’ç‘ªåˆ©äº','åšè¦‹è­‰':'ä½œè¦‹è­‰','æŠµæ¯€':'è©†æ¯€',
  'æœä¾':'æœäº‹','æ¨¡æ“¬å…©å¯':'æ¨¡ç¨œå…©å¯','ç´„æ—¦æ²³':'ç´„ä½†æ²³','ä¼¸ä»—':'ä¼¸æ–','æ’’æ—¦':'æ’’ä½†',
  'ç”Ÿæ´»ç„¡æ…®':'ç”Ÿæ´»ç„¡è™','å‘¨å…­':'é€±å…­','çœ¼è‡‰':'çœ¼ç¼','éƒ¨ä»½':'éƒ¨åˆ†','æ·ºç§»é»˜åŒ–':'æ½›ç§»é»˜åŒ–',
  'ä½ˆæ»¿':'å¸ƒæ»¿','ç¹å»¶':'ç¹è¡','å…¬ä½ˆ':'å…¬å¸ƒ','é »è‡¨':'ç€•è‡¨','ä½ˆç½®':'å¸ƒç½®',
  'æœ­æ ¹':'æ‰æ ¹','æ‰ç‡Ÿ':'ç´®ç‡Ÿ','æ‰å¯¦':'ç´®å¯¦','ç§˜è¨£':'ç¥•è¨£','é›¨éå¤©æ™´':'é›¨éå¤©é’',
  'æ™´å¤©éœ¹é‚':'é’å¤©éœ¹é‚','è¬›åœ‹èª':'è¬›ä¸­æ–‡','è‡ºèª':'é–©å—èª','èƒŒé€†':'æ‚–é€†','å¿…éœ€':'å¿…é ˆ',
  'é ˆè¦':'éœ€è¦','æ¼«å»¶':'è”“å»¶','ç¶‘ç¶':'æ†ç¶','é£¢è’':'é¥‘è’','è­¦é†’':'å„†é†’',
  'å¤¢é¨':'å¤¢é­˜','è£œé¢¨':'æ•é¢¨','ä¸æŠ€ä¸æ±‚':'ä¸å¿®ä¸æ±‚','æ—¥æ¼¸å¥½è½‰':'æ—¥è¦‹å¥½è½‰','æ¦»é™·':'å¡Œé™·',
  'è¦ç•«':'è¦åŠƒ','ä¼ç•«':'ä¼åŠƒ'
};

// B) ç¶“æ–‡ç°¡ç¨± (å®Œæ•´ä¿ç•™)
const bookAbbreviations = {
  'å‰µä¸–è¨˜':'å‰µ','å‡ºåŸƒåŠè¨˜':'å‡º','åˆ©æœªè¨˜':'åˆ©','æ°‘æ•¸è¨˜':'æ°‘','ç”³å‘½è¨˜':'ç”³',
  'ç´„æ›¸äºè¨˜':'æ›¸','å£«å¸«è¨˜':'å£«','è·¯å¾—è¨˜':'å¾—','æ’’æ¯è€³è¨˜ä¸Š':'æ’’ä¸Š','æ’’æ¯è€³è¨˜ä¸‹':'æ’’ä¸‹',
  'åˆ—ç‹ç´€ä¸Š':'ç‹ä¸Š','åˆ—ç‹ç´€ä¸‹':'ç‹ä¸‹','æ­·ä»£å¿—ä¸Š':'ä»£ä¸Š','æ­·ä»£å¿—ä¸‹':'ä»£ä¸‹','ä»¥æ–¯æ‹‰è¨˜':'æ‹‰',
  'å°¼å¸Œç±³è¨˜':'å°¼','ä»¥æ–¯å¸–è¨˜':'æ–¯','ç´„ä¼¯è¨˜':'ä¼¯','è©©ç¯‡':'è©©','ç®´è¨€':'ç®´',
  'å‚³é“æ›¸':'å‚³','é›…æ­Œ':'æ­Œ','ä»¥è³½äºæ›¸':'è³½','è€¶åˆ©ç±³æ›¸':'è€¶','è€¶åˆ©ç±³å“€æ­Œ':'å“€',
  'ä»¥è¥¿çµæ›¸':'çµ','ä½†ä»¥ç†æ›¸':'ä½†','ä½•è¥¿é˜¿æ›¸':'ä½•','ç´„ç¥æ›¸':'ç¥','é˜¿æ‘©å¸æ›¸':'æ‘©',
  'ä¿„å·´åº•äºæ›¸':'ä¿„','ç´„æ‹¿æ›¸':'æ‹¿','å½Œè¿¦æ›¸':'å½Œ','é‚£é´»æ›¸':'é´»','å“ˆå·´è°·æ›¸':'å“ˆ',
  'è¥¿ç•ªé›…æ›¸':'ç•ª','å“ˆè©²æ›¸':'è©²','æ’’è¿¦åˆ©äºæ›¸':'äº','ç‘ªæ‹‰åŸºæ›¸':'ç‘ª',
  'é¦¬å¤ªç¦éŸ³':'å¤ª','é¦¬å¯ç¦éŸ³':'å¯','è·¯åŠ ç¦éŸ³':'è·¯','ç´„ç¿°ç¦éŸ³':'ç´„','ä½¿å¾’è¡Œå‚³':'å¾’',
  'ç¾…é¦¬æ›¸':'ç¾…','å“¥æ—å¤šå‰æ›¸':'æ—å‰','å“¥æ—å¤šå¾Œæ›¸':'æ—å¾Œ','åŠ æ‹‰å¤ªæ›¸':'åŠ ','ä»¥å¼—æ‰€æ›¸':'å¼—',
  'è…“ç«‹æ¯”æ›¸':'è…“','æ­Œç¾…è¥¿æ›¸':'è¥¿','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'å¸–å‰','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'å¸–å¾Œ','ææ‘©å¤ªå‰æ›¸':'æå‰',
  'ææ‘©å¤ªå¾Œæ›¸':'æå¾Œ','æå¤šæ›¸':'å¤š','è…“åˆ©é–€æ›¸':'é–€','å¸Œä¼¯ä¾†æ›¸':'ä¾†','é›…å„æ›¸':'é›…',
  'å½¼å¾—å‰æ›¸':'å½¼å‰','å½¼å¾—å¾Œæ›¸':'å½¼å¾Œ','ç´„ç¿°ä¸€æ›¸':'ç´„ä¸€','ç´„ç¿°äºŒæ›¸':'ç´„äºŒ','ç´„ç¿°ä¸‰æ›¸':'ç´„ä¸‰',
  'çŒ¶å¤§æ›¸':'çŒ¶','å•Ÿç¤ºéŒ„':'å•Ÿ',
  'é¦¬å¤ª':'å¤ª','é¦¬å¯':'å¯','è·¯åŠ ':'è·¯','ç´„ç¿°':'ç´„'
};

// C) Book Map (å®Œæ•´ä¿ç•™)
const bookMap = {
  // èˆŠç´„
  'å‰µ':'Gen','å‰µä¸–':'Gen','å‰µä¸–è¨˜':'Gen',
  'å‡º':'Exo','å‡ºåŸƒåŠ':'Exo','å‡ºåŸƒåŠè¨˜':'Exo',
  'åˆ©':'Lev','åˆ©æœª':'Lev','åˆ©æœªè¨˜':'Lev',
  'æ°‘':'Num','æ°‘æ•¸':'Num','æ°‘æ•¸è¨˜':'Num',
  'ç”³':'Deu','ç”³å‘½':'Deu','ç”³å‘½è¨˜':'Deu',
  'æ›¸':'Jos','ç´„æ›¸äº':'Jos','ç´„æ›¸äºè¨˜':'Jos',
  'å£«':'Jug','å£«å¸«':'Jug','å£«å¸«è¨˜':'Jug',
  'å¾—':'Rut','è·¯å¾—':'Rut','è·¯å¾—è¨˜':'Rut',
  'æ’’ä¸Š':'1Sa','æ’’æ¯è€³ä¸Š':'1Sa','æ’’æ¯è€³è¨˜ä¸Š':'1Sa',
  'æ’’ä¸‹':'2Sa','æ’’æ¯è€³ä¸‹':'2Sa','æ’’æ¯è€³è¨˜ä¸‹':'2Sa',
  'ç‹ä¸Š':'1Ki','åˆ—ç‹ä¸Š':'1Ki','åˆ—ç‹è¨˜ä¸Š':'1Ki',
  'ç‹ä¸‹':'2Ki','åˆ—ç‹ä¸‹':'2Ki','åˆ—ç‹è¨˜ä¸‹':'2Ki',
  'ä»£ä¸Š':'1Ch','æ­·ä»£ä¸Š':'1Ch','æ­·ä»£å¿—ä¸Š':'1Ch',
  'ä»£ä¸‹':'2Ch','æ­·ä»£ä¸‹':'2Ch','æ­·ä»£å¿—ä¸‹':'2Ch',
  'æ‹‰':'Ezr','ä»¥æ–¯æ‹‰':'Ezr','ä»¥æ–¯æ‹‰è¨˜':'Ezr',
  'å°¼':'Neh','å°¼å¸Œç±³':'Neh','å°¼å¸Œç±³è¨˜':'Neh',
  'æ–¯':'Est','ä»¥æ–¯å¸–':'Est','ä»¥æ–¯å¸–è¨˜':'Est',
  'ä¼¯':'Job','ç´„ä¼¯':'Job','ç´„ä¼¯è¨˜':'Job',
  'è©©':'Psm','è©©ç¯‡':'Psm',
  'ç®´':'Pro','ç®´è¨€':'Pro',
  'å‚³':'Ecc','å‚³é“':'Ecc','å‚³é“æ›¸':'Ecc',
  'æ­Œ':'Son','é›…æ­Œ':'Son',
  'è³½':'Isa','ä»¥è³½äº':'Isa','ä»¥è³½äºæ›¸':'Isa',
  'è€¶':'Jer','è€¶åˆ©ç±³':'Jer','è€¶åˆ©ç±³æ›¸':'Jer',
  'å“€':'Lam','è€¶åˆ©ç±³å“€':'Lam','è€¶åˆ©ç±³å“€æ­Œ':'Lam',
  'çµ':'Eze','ä»¥è¥¿çµ':'Eze','ä»¥è¥¿çµæ›¸':'Eze',
  'ä½†':'Dan','ä½†ä»¥ç†':'Dan','ä½†ä»¥ç†æ›¸':'Dan',
  'ä½•':'Hos','ä½•è¥¿é˜¿':'Hos','ä½•è¥¿é˜¿æ›¸':'Hos',
  'ç¥':'Joe','ç´„ç¥':'Joe','ç´„ç¥æ›¸':'Joe',
  'æ‘©':'Amo','é˜¿æ‘©å¸':'Amo','é˜¿æ‘©å¸æ›¸':'Amo',
  'ä¿„':'Oba','ä¿„å·´åº•äº':'Oba','ä¿„å·´åº•äºæ›¸':'Oba',
  'æ‹¿':'Jon','ç´„æ‹¿':'Jon','ç´„æ‹¿æ›¸':'Jon',
  'å½Œ':'Mic','å½Œè¿¦':'Mic','å½Œè¿¦æ›¸':'Mic',
  'é´»':'Nah','é‚£é´»':'Nah','é‚£é´»æ›¸':'Nah',
  'å“ˆ':'Hab','å“ˆå·´è°·':'Hab','å“ˆå·´è°·æ›¸':'Hab',
  'ç•ª':'Zep','è¥¿ç•ªé›…':'Zep','è¥¿ç•ªé›…æ›¸':'Zep',
  'è©²':'Hag','å“ˆè©²':'Hag','å“ˆè©²æ›¸':'Hag',
  'äº':'Zec','æ’’è¿¦åˆ©äº':'Zec','æ’’è¿¦åˆ©äºæ›¸':'Zec',
  'ç‘ª':'Mal','ç‘ªæ‹‰åŸº':'Mal','ç‘ªæ‹‰åŸºæ›¸':'Mal',
  // æ–°ç´„
  'å¤ª':'Mat','é¦¬å¤ª':'Mat','é¦¬å¤ªç¦éŸ³':'Mat',
  'å¯':'Mak','é¦¬å¯':'Mak','é¦¬å¯ç¦éŸ³':'Mak',
  'è·¯':'Luk','è·¯åŠ ':'Luk','è·¯åŠ ç¦éŸ³':'Luk',
  'ç´„':'Jhn','ç´„ç¿°':'Jhn','ç´„ç¿°ç¦éŸ³':'Jhn',
  'å¾’':'Act','ä½¿å¾’':'Act','ä½¿å¾’è¡Œå‚³':'Act',
  'ç¾…':'Rom','ç¾…é¦¬':'Rom','ç¾…é¦¬æ›¸':'Rom',
  'æ—å‰':'1Co','å“¥æ—å¤šå‰':'1Co','å“¥æ—å¤šå‰æ›¸':'1Co',
  'æ—å¾Œ':'2Co','å“¥æ—å¤šå¾Œ':'2Co','å“¥æ—å¤šå¾Œæ›¸':'2Co',
  'åŠ ':'Gal','åŠ æ‹‰å¤ª':'Gal','åŠ æ‹‰å¤ªæ›¸':'Gal',
  'å¼—':'Eph','ä»¥å¼—æ‰€':'Eph','ä»¥å¼—æ‰€æ›¸':'Eph',
  'è…“':'Phl','è…“ç«‹æ¯”':'Phl','è…“ç«‹æ¯”æ›¸':'Phl',
  'è¥¿':'Col','æ­Œç¾…è¥¿':'Col','æ­Œç¾…è¥¿æ›¸':'Col',
  'å¸–å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰':'1Ts','å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸':'1Ts',
  'å¸–å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œ':'2Ts','å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸':'2Ts',
  'æå‰':'1Ti','ææ‘©å¤ªå‰':'1Ti','ææ‘©å¤ªå‰æ›¸':'1Ti',
  'æå¾Œ':'2Ti','ææ‘©å¤ªå¾Œ':'2Ti','ææ‘©å¤ªå¾Œæ›¸':'2Ti',
  'å¤š':'Tit','æå¤š':'Tit','æå¤šæ›¸':'Tit',
  'é–€':'Phm','è…“åˆ©é–€':'Phm','è…“åˆ©é–€æ›¸':'Phm',
  'ä¾†':'Heb','å¸Œä¼¯ä¾†':'Heb','å¸Œä¼¯ä¾†æ›¸':'Heb',
  'é›…':'Jas','é›…å„':'Jas','é›…å„æ›¸':'Jas',
  'å½¼å‰':'1Pe','å½¼å¾—å‰':'1Pe','å½¼å¾—å‰æ›¸':'1Pe',
  'å½¼å¾Œ':'2Pe','å½¼å¾—å¾Œ':'2Pe','å½¼å¾—å¾Œæ›¸':'2Pe',
  'ç´„ä¸€':'1Jn','ç´„ç¿°ä¸€':'1Jn','ç´„ç¿°ä¸€æ›¸':'1Jn',
  'ç´„äºŒ':'2Jn','ç´„ç¿°äºŒ':'2Jn','ç´„ç¿°äºŒæ›¸':'2Jn',
  'ç´„ä¸‰':'3Jn','ç´„ç¿°ä¸‰':'3Jn','ç´„ç¿°ä¸‰æ›¸':'3Jn',
  'çŒ¶':'Jud','çŒ¶å¤§':'Jud','çŒ¶å¤§æ›¸':'Jud',
  'å•Ÿ':'Rev','å•Ÿç¤º':'Rev','å•Ÿç¤ºéŒ„':'Rev'
};
const sortedBookNames = Object.keys(bookMap).sort((a,b)=>b.length-a.length);

// D) ç« æ•¸è½‰ä¸­æ–‡å·¥å…· (å®Œæ•´ä¿ç•™)
function chineseToNumber(chineseNum){
  const cnNums={'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9};
  const cnUnits={'å':10,'ç™¾':100,'åƒ':1000,'è¬':10000};
  if (/^\d+$/.test(chineseNum)) return parseInt(chineseNum,10);
  let total=0, section=0, number=0, unitOps=false;
  for(let i=0;i<chineseNum.length;i++){
    const c=chineseNum.charAt(i);
    if(cnNums.hasOwnProperty(c)){ number=cnNums[c]; unitOps=false; }
    else if(cnUnits.hasOwnProperty(c)){
      let unit=cnUnits[c];
      if(unit===10 && number===0 && !unitOps) number=1;
      section=(section+number)*unit;
      if(unit>=10000){ total+=section; section=0; } else { total+=section; section=0; }
      number=0; unitOps=true;
    } else if(/\d/.test(c)){ number=parseInt(c,10); }
  }
  if(!unitOps) total+=number;
  if(total===0 && chineseNum.startsWith('å')){ let temp=10; if(chineseNum.length>1) temp+=cnNums[chineseNum[1]]||0; return temp; }
  return total>0?total:number;
}
function numberToChinese(num){
  const cnNums=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  const cnUnits=['','å','ç™¾','åƒ'];
  if(num===0) return 'é›¶'; if(num===10) return 'å';
  if(num>10 && num<20) return 'å'+cnNums[num%10];
  let str='', s=num.toString(), len=s.length;
  for(let i=0;i<len;i++){
    let n=parseInt(s.charAt(len-i-1));
    let digit=cnNums[n], unit=cnUnits[i];
    if(n!==0) str=digit+unit+str; else if(str.length>0 && !str.startsWith('é›¶')) str='é›¶'+str;
  }
  return str.replace(/é›¶+$/,'');
}

// E) Bible CSV è¼‰å…¥ & Worker (å®Œæ•´ä¿ç•™)
let bibleData=[];
let bibleReady=false;
let openccReady=false;
let t2s=null, s2t=null;

async function initOpenCC(){
  try{
    t2s = OpenCC.Converter({ from:'tw', to:'cn' });
    s2t = OpenCC.Converter({ from:'cn', to:'tw' });
    openccReady=true;
  }catch(e){ openccReady=false; console.warn('OpenCC init fail', e); }
}

function parseCSVInWorker(csvText){
  return new Promise((resolve)=>{
    const workerCode = `
      self.onmessage = (e) => {
        const lines = e.data.split(/\\r?\\n/);
        const out = [];
        for (let i=1;i<lines.length;i++){
          const row = lines[i]; if(!row) continue;
          const parts = row.split(',');
          if(parts.length>=4){
            const c = parseInt(parts[1].trim());
            const v = parseInt(parts[2].trim());
            if(!isNaN(c) && !isNaN(v)){
              out.push({
                book: parts[0].trim(), chapter: c, verse: v,
                text: parts.slice(3).join(',').trim(), id: c*1000 + v
              });
            }
          }
        }
        postMessage(out);
      };
    `;
    const blob=new Blob([workerCode],{type:'application/javascript'});
    const worker=new Worker(URL.createObjectURL(blob));
    worker.onmessage=(ev)=>{ bibleData=ev.data||[]; worker.terminate(); resolve(); };
    worker.postMessage(csvText);
  });
}

async function loadBibleCSV(){
  const outputEl=document.getElementById('output');
  try{
    const res = await fetch(`./bible.csv?v=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=(await res.text()).replace(/^\uFEFF/,'');
    await parseCSVInWorker(text);
    bibleReady=true;
    setAutosaveBadge('CSV è¼‰å…¥æˆåŠŸ');
  }catch(e){
    bibleReady=false;
    setAutosaveBadge('CSV è¼‰å…¥å¤±æ•—', true);
  }
}

// F) ç¶“æ–‡å¼•ç”¨è§£æ Regex (å®Œæ•´ä¿ç•™)
function cnToNum(str){ /* å·²æ•´åˆåœ¨ chineseToNumber ä¸Šæ–¹ï¼Œæ­¤è™•ç‚ºè§£æåƒè€ƒçš„è¼”åŠ© */
    return chineseToNumber(str);
}
function parseRefPart(str, defaultBook, defaultChapter){
  let bookKey=defaultBook; let remain=str; let hasBookInStr=false;
  for(const key of sortedBookNames){
    if(str.startsWith(key)){ bookKey=bookMap[key]; remain=str.substring(key.length); hasBookInStr=true; break; }
  }
  remain=remain.replace(/[.ï¼ã€‚,ï¼Œ]/g,':');
  let c,v, splitIdx=-1;
  const isDigit=(ch)=>/[0-9]/.test(ch);
  const isCnDigit=(ch)=>/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]/.test(ch);
  for(let i=0;i<remain.length-1;i++){ if(isCnDigit(remain[i]) && isDigit(remain[i+1])){ splitIdx=i+1; break; } }
  
  if(remain.includes(':')){
    const p=remain.split(':'); c = cnToNum(p[0]) || parseInt(p[0]); v = cnToNum(p[1]) || parseInt(p[1]);
  }else if(splitIdx!==-1){
    c = cnToNum(remain.substring(0,splitIdx)); v = parseInt(remain.substring(splitIdx));
  }else{
    const val = cnToNum(remain) || parseInt(remain);
    if(defaultChapter && !hasBookInStr){ c=defaultChapter; v=val; } else { c=val; v=null; }
  }
  return { book: bookKey, chapter: c, verse: v, id: (c && v) ? (c*1000+v) : null, isChapterOnly: (c && !v) };
}

function parseSearchQuery(input){
  let clean=input.replace(/\s+/g,'').replace(/[.ï¼ã€‚,ï¼Œ]/g,':').replace(/[â€”~ï½]/g,'-');
  clean=clean.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾])(\d)/g,'$1:$2');
  if(clean.includes('-')){
    const [startStr,endStr]=clean.split('-');
    const startObj=parseRefPart(startStr,null,null);
    if(!startObj.chapter) return null;
    const contextChap = startObj.verse ? startObj.chapter : null;
    const endObj=parseRefPart(endStr,startObj.book,contextChap);
    if(!endObj.book) endObj.book=startObj.book;
    let startId=startObj.id; let endId=0;
    if(endObj.verse) endId=endObj.chapter*1000+endObj.verse; else endId=endObj.chapter*1000+999;
    if(startObj.isChapterOnly) startId=startObj.chapter*1000;
    return { type:'range', book:startObj.book, startId, endId };
  }else{
    const obj=parseRefPart(clean,null,null);
    return { type:'single', book:obj.book, chapter:obj.chapter, verse:obj.verse };
  }
}

// G) æŸ¥æ‰¾èˆ‡æ ¼å¼åŒ– (å®Œæ•´ä¿ç•™)
function bookCodeToShort(bookCode){
  const keys = Object.keys(bookMap).filter(k=>bookMap[k]===bookCode);
  if(!keys.length) return bookCode;
  keys.sort((a,b)=>a.length-b.length); return keys[0];
}
function formatRefShort(bookCode, chapter, verse){
  const short=bookCodeToShort(bookCode);
  const chapChi=numberToChinese(parseInt(chapter));
  const vStr = (verse!==null && verse!==undefined) ? String(verse) : '';
  return `ï¼ˆ${short}${chapChi}${vStr}ï¼‰`;
}
function findVersesByQuery(query){
  if(!bibleReady || !query) return [];
  if(query.type==='range') return bibleData.filter(e=>e.book===query.book && e.id>=query.startId && e.id<=query.endId);
  if(!query.book || !query.chapter) return [];
  const c=parseInt(query.chapter);
  if(query.verse===null || query.verse===undefined) return bibleData.filter(e=>e.book===query.book && e.chapter===c);
  const v=parseInt(query.verse);
  return bibleData.filter(e=>e.book===query.book && e.chapter===c && e.verse===v);
}
function buildInsertText(verses){
  if(!verses.length) return '';
  return verses.map(e=>`${e.text} ${formatRefShort(e.book, e.chapter, e.verse)}`).join('\n');
}

// H) åµæ¸¬é‚è¼¯ (UI æ”¹ç‚ºæ§åˆ¶æ‰‹æ©Ÿæµ®çª—)
let lastDetected = null;
function getLastTokenNearCursor(text, cursor){
  let i = cursor - 1; while(i>=0 && !/\s/.test(text[i])) i--; const start=i+1;
  let j = cursor; while(j<text.length && !/\s/.test(text[j])) j++; const end=j;
  return { token:text.slice(start,end), start, end };
}
function maybeDetectVerse(){
  const autoOn=document.getElementById('autoVerseToggle').checked;
  if(!autoOn) return;
  const ta=document.getElementById('inputText');
  const text=ta.value; const cursor=ta.selectionStart;
  const { token, start, end } = getLastTokenNearCursor(text, cursor);
  if(!token || token.length < 3) { closeVersePop(); return; }
  const cleaned = token.replace(/[()ï¼ˆï¼‰\[\]]/g,'').trim();
  const q=parseSearchQuery(cleaned);
  if(!q) { closeVersePop(); return; }
  const verses=findVersesByQuery(q).slice(0, 30);
  if(!verses.length) { closeVersePop(); return; }
  if(q.type==='single' && (q.verse===null || q.verse===undefined)) { closeVersePop(); return; }
  
  const insertText = buildInsertText(verses);
  lastDetected = { token, cleaned, start, end, verses, insertText };
  
  const pop=document.getElementById('versePop');
  const refEl=document.getElementById('versePopRef');
  const txtEl=document.getElementById('versePopText');
  const first=verses[0];
  refEl.textContent = formatRefShort(first.book, first.chapter, first.verse);
  txtEl.textContent = insertText;
  pop.classList.add('show');
}
function closeVersePop(){
  document.getElementById('versePop').classList.remove('show');
  lastDetected=null;
}
function insertVerse(){
  if(!lastDetected) return;
  const ta=document.getElementById('inputText');
  const replaceOn=document.getElementById('replaceRefToggle').checked;
  const insertText = lastDetected.insertText;
  const before = ta.value.slice(0, replaceOn ? lastDetected.start : ta.selectionStart);
  const after  = ta.value.slice(replaceOn ? lastDetected.end : ta.selectionEnd);
  ta.value = before + insertText + after;
  const pos = (before + insertText).length;
  ta.focus(); ta.setSelectionRange(pos, pos);
  closeVersePop(); triggerAutosave(); processText();
}

// I) æ ¡ç¨¿é‚è¼¯ (å®Œæ•´ä¿ç•™)
function applyHardRulesPlain(text){
  for(const [from,to] of hardRules){ text = text.split(from).join(to); } return text;
}
function applyTyposPlain(text){
  const keys = Object.keys(typoCorrections).sort((a,b)=>b.length-a.length);
  for(const k of keys){ text = text.split(k).join(typoCorrections[k]); } return text;
}
function getCleanFixedText(text){ text = applyHardRulesPlain(text); text = applyTyposPlain(text); return text; }
function processText(){
  const inputEl=document.getElementById('inputText');
  const outputEl=document.getElementById('output');
  let text=inputEl.value;
  if(!text){ outputEl.innerHTML='<span style="color:#999;">ç­‰å¾…è¼¸å…¥...</span>'; return; }
  let preview=text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  
  for(const [from,to] of hardRules){
    const re=new RegExp(from.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview = preview.replace(re, `<span class="highlight-typo">${from}</span><span class="highlight-correction">${to}</span>`);
  }
  for(let typo in typoCorrections){
    const correction=typoCorrections[typo];
    const re=new RegExp(typo.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    preview=preview.replace(re, `<span class="highlight-typo">${typo}</span><span class="highlight-correction">${correction}</span>`);
  }
  
  // ç¶“æ–‡å¼•ç”¨è§£æ
  preview = preview.replace(/ï¼ˆ([^ï¼‰]+)ï¼‰/g, function(match, content){
    let foundBook=null, bookAbbr='';
    let sortedBooks=Object.keys(bookAbbreviations).sort((a,b)=>b.length-a.length);
    for(let book of sortedBooks){ if(content.startsWith(book)){ foundBook=book; bookAbbr=bookAbbreviations[book]; break; } }
    if(!foundBook) return match;
    let remain=content.substring(foundBook.length).trim();
    let cleanRef=remain.replace(/[ç« ç¯‡ç¯€\s]/g,':').replace(/[:ï¼š.ï¼]+/g,':');
    let parts=cleanRef.split(':').filter(p=>p);
    if(parts.length===0) return match;
    let chapter=parts[0]; let verse=parts.length>1 ? parts[1] : '';
    let chapterNum=chineseToNumber(chapter); let chapterChi=numberToChinese(chapterNum);
    let verseStr='';
    if(verse){
       if(verse.includes('-')||verse.includes('ï¼')||verse.includes('è‡³')){
         let vParts=verse.split(/[-ï¼è‡³]/);
         let v1=chineseToNumber(vParts[0]); let v2=chineseToNumber(vParts[1]);
         verseStr=`${v1}-${v2}`;
       }else{ verseStr=chineseToNumber(verse).toString(); }
    }
    let newRef=`ï¼ˆ${bookAbbr}${chapterChi}${verseStr}ï¼‰`;
    return `<span class="highlight-scripture">${newRef}</span>`;
  });
  preview = preview.replace(/\n/g,'<br>');
  outputEl.innerHTML=preview;
}
function applyFixesToInput(){
  const ta=document.getElementById('inputText'); ta.value=getCleanFixedText(ta.value);
  triggerAutosave(); processText(); alert('å·²å®Œæˆä¸€éµä¿®æ­£');
}

// J) OpenCC è½‰æ› (å®Œæ•´ä¿ç•™)
function toSimplified(){
  if(!openccReady){ alert('OpenCC è¼‰å…¥ä¸­...'); return; }
  const ta=document.getElementById('inputText');
  let out=t2s(ta.value); out=getCleanFixedText(out);
  ta.value=out; triggerAutosave(); processText();
}
function toTraditional(){
  if(!openccReady){ alert('OpenCC è¼‰å…¥ä¸­...'); return; }
  const ta=document.getElementById('inputText');
  let out=s2t(ta.value); out=getCleanFixedText(out);
  ta.value=out; triggerAutosave(); processText();
}

// K) å·¥å…·å‡½æ•¸ (è¤‡è£½/æ¸…ç©º)
function copyResult(){
  const outputEl=document.getElementById('output');
  let tempDiv=document.createElement('div'); tempDiv.innerHTML=outputEl.innerHTML;
  tempDiv.querySelectorAll('.highlight-typo').forEach(el=>el.remove());
  const finalCopyText=tempDiv.innerText;
  navigator.clipboard.writeText(finalCopyText).then(()=>alert('æ ¡ç¨¿çµæœå·²è¤‡è£½'));
}
function clearText(){
  if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')){
    document.getElementById('inputText').value='';
    document.getElementById('output').innerHTML='';
    localStorage.removeItem('writer_draft_v1');
    closeVersePop(); setAutosaveBadge('å·²æ¸…ç©º', true);
  }
}

// L) è‡ªå‹•å­˜æª”
let autosaveTimer=null;
function setAutosaveBadge(text, danger=false){
  const b=document.getElementById('autosaveBadge'); b.textContent=text;
  b.className = danger ? 'status-badge' : 'status-badge saving';
  if(!danger) setTimeout(()=>b.className='status-badge', 1000);
}
function triggerAutosave(){
  clearTimeout(autosaveTimer);
  autosaveTimer=setTimeout(()=>{
    const ta=document.getElementById('inputText');
    localStorage.setItem('writer_draft_v1', ta.value);
    setAutosaveBadge('å·²å„²å­˜');
  }, 500);
}

// åˆå§‹åŒ–
window.addEventListener('load', async ()=>{
  await initOpenCC();
  await loadBibleCSV();
  const ta=document.getElementById('inputText');
  const saved=localStorage.getItem('writer_draft_v1');
  if(saved){ ta.value=saved; setAutosaveBadge('è‰ç¨¿å·²æ¢å¾©'); }
  
  ta.addEventListener('input', ()=>{
    triggerAutosave();
    // é è¦½é é¢ä¸å³æ™‚æ¸²æŸ“ï¼Œçœæ•ˆèƒ½ï¼Œåˆ‡æ› tab æ™‚æ‰æ¸²æŸ“
    // ç¶“æ–‡åµæ¸¬ä¿ç•™
    clearTimeout(window.__verseDetectTimer);
    window.__verseDetectTimer=setTimeout(maybeDetectVerse, 220);
  });
  
  ta.addEventListener('keyup', (e)=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      clearTimeout(window.__verseDetectTimer);
      window.__verseDetectTimer=setTimeout(maybeDetectVerse, 180);
    }
  });

  // å¿«æ·éµæ”¯æ´
  document.addEventListener('keydown', (e)=>{
    const popShown = document.getElementById('versePop').classList.contains('show');
    if(e.key==='Escape' && popShown) closeVersePop();
    if(e.altKey && e.key==='Enter' && popShown){ e.preventDefault(); insertVerse(); }
  });
});
</script>
</body>
</html>
